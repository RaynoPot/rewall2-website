<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ReWall NZ Services - Full-service retaining wall solutions, engineering design, council submissions, and construction oversight.">
    <meta name="keywords" content="retaining wall services, engineering design, council submissions, construction">
    
    <meta property="og:title" content="Services - ReWall NZ">
    <meta property="og:description" content="Complete retaining wall solutions and flexible Mix & Match services">
    
    <title>Services - ReWall NZ</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <style>
        /* Quote Builder Styles */
        .quote-builder {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: var(--spacing-xxl) 0;
            border-top: 3px solid var(--teal-accent);
        }
        
        .quote-step {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 4px solid var(--teal-accent);
        }
        
        .quote-step-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: var(--teal-accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .step-number.completed {
            background: #28a745;
        }
        
        .quote-step h3 {
            margin: 0;
            color: var(--primary-black);
        }
        
        .quote-step-description {
            color: var(--slate);
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }
        
        /* Map Container */
        #map-container {
            height: 500px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-gray);
            margin-bottom: var(--spacing-md);
            position: relative;
        }
        
        #site-map {
            height: 100%;
            width: 100%;
        }
        
        /* Drawing Tool Enhancement - Pulsing Animation */
        .leaflet-draw-toolbar {
            animation: drawToolPulse 2s ease-in-out infinite;
        }
        
        @keyframes drawToolPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(74, 144, 164, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(74, 144, 164, 0);
            }
        }
        
        /* Floating Tooltip Prompt for Drawing Tool */
        .draw-prompt-tooltip {
            position: absolute;
            left: 70px;
            top: 10px;
            background: linear-gradient(135deg, #4A90A4 0%, #2C7A99 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 4px 20px rgba(74, 144, 164, 0.4);
            z-index: 1000;
            animation: tooltipBounce 2s ease-in-out infinite;
            pointer-events: none;
            max-width: 250px;
        }
        
        .draw-prompt-tooltip::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid #4A90A4;
        }
        
        .draw-prompt-tooltip .prompt-icon {
            display: inline-block;
            margin-right: 6px;
            animation: pointFinger 1s ease-in-out infinite;
        }
        
        @keyframes tooltipBounce {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(8px);
            }
        }
        
        @keyframes pointFinger {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        
        /* Hide tooltip when drawing starts */
        .draw-prompt-tooltip.hidden {
            display: none;
        }
        
        /* Enhanced draw button styling */
        .leaflet-draw-draw-polyline {
            background-color: #4A90A4 !important;
            border: 2px solid white !important;
            border-radius: 6px !important;
            transition: all 0.3s ease !important;
        }
        
        .leaflet-draw-draw-polyline:hover {
            background-color: #2C7A99 !important;
            transform: scale(1.1);
        }
        
        .map-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Enhanced Address Search with Autocomplete */
        .address-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .address-search-wrapper {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .address-search input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .address-search input:focus {
            border-color: var(--teal-accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 164, 0.2);
        }
        
        .address-search button {
            padding: 12px 24px;
            background: var(--teal-accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .address-search button:hover {
            background: #3a8a9a;
        }
        
        .address-search button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Autocomplete Dropdown */
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--teal-accent);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            max-height: 300px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .address-suggestions.active {
            display: block;
        }
        
        .address-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-gray);
            transition: all 0.2s ease;
        }
        
        .address-suggestion:last-child {
            border-bottom: none;
        }
        
        .address-suggestion:hover {
            background: var(--soft-blue);
        }
        
        .address-suggestion .suggestion-main {
            font-weight: 600;
            color: var(--primary-black);
        }
        
        .address-suggestion .suggestion-secondary {
            font-size: 0.85rem;
            color: var(--slate);
            margin-top: 2px;
        }
        
        .address-searching {
            padding: 16px;
            text-align: center;
            color: var(--slate);
        }
        
        .address-searching::before {
            content: "üîç ";
        }
        
        .map-layer-toggle {
            display: flex;
            gap: var(--spacing-xs);
            background: white;
            padding: 4px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-gray);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .map-layer-toggle button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--charcoal);
        }
        
        .map-layer-toggle button:hover {
            background: var(--light-gray);
        }
        
        .map-layer-toggle button.active {
            background: var(--teal-accent);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 144, 164, 0.3);
        }
        
        /* Layer toggles - Enhanced styling */
        .layer-toggles {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .layer-toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 16px;
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .layer-toggle-item:hover {
            background: var(--soft-blue);
            border-color: var(--teal-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 144, 164, 0.15);
        }
        
        .layer-toggle-item.active {
            background: linear-gradient(135deg, var(--teal-accent) 0%, #3a8a9a 100%);
            color: white;
            border-color: var(--teal-accent);
            box-shadow: 0 4px 12px rgba(74, 144, 164, 0.3);
        }
        
        .layer-toggle-item.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 144, 164, 0.4);
        }
        
        .layer-toggle-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--teal-accent);
            cursor: pointer;
        }
        
        .layer-toggle-item.active input[type="checkbox"] {
            accent-color: white;
        }
        
        .layer-toggle-item span {
            user-select: none;
        }
        
        .drawing-info {
            background: #e3f2fd;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            border-left: 4px solid #2196f3;
        }
        
        .drawing-info h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: #1976d2;
        }
        
        .drawing-info p {
            margin: 0;
            color: var(--slate);
            font-size: 0.95rem;
        }
        
        .drawn-walls-list {
            margin-top: var(--spacing-md);
            background: var(--light-gray);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }
        
        .drawn-walls-list h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--primary-black);
        }
        
        .wall-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .wall-item:last-child {
            margin-bottom: 0;
        }
        
        .wall-item .wall-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .wall-item .wall-length {
            font-weight: 600;
            color: var(--teal-accent);
        }
        
        .wall-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .total-length {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--teal-accent);
            color: white;
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Wall Type Selection */
        .wall-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .wall-type-option {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--light-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .wall-type-option:hover {
            border-color: var(--teal-accent);
            background: white;
        }
        
        .wall-type-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: var(--spacing-sm);
            accent-color: var(--teal-accent);
        }
        
        .wall-type-option.selected {
            border-color: var(--teal-accent);
            background: #e8f4f5;
        }
        
        .wall-type-option label {
            cursor: pointer;
            font-weight: 500;
        }
        
        .other-input {
            margin-top: var(--spacing-sm);
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-sm);
            display: none;
        }
        
        .other-input.visible {
            display: block;
        }
        
        /* Quote Summary */
        .quote-summary {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-xl);
        }
        
        .quote-summary h3 {
            color: var(--teal-accent);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }
        
        .summary-section {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-section:last-of-type {
            border-bottom: none;
        }
        
        .summary-section h4 {
            color: var(--baby-blue);
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-section p, .summary-section ul {
            margin: 0;
            color: rgba(255,255,255,0.9);
        }
        
        .summary-section ul {
            list-style: none;
            padding: 0;
        }
        
        .summary-section li {
            padding: 4px 0;
        }
        
        .submit-quote-btn {
            width: 100%;
            padding: 16px 32px;
            background: var(--teal-accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .submit-quote-btn:hover {
            background: #3a8a9a;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 144, 164, 0.4);
        }
        
        .submit-quote-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .optional-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: var(--spacing-sm);
        }
        
        /* Live distance tooltip */
        .distance-tooltip {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        /* Service Tags */
        .service-tag {
            display: inline-block;
            background: var(--teal-accent);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Search Marker */
        .search-marker {
            font-size: 24px;
            text-align: center;
        }
        
        /* Leaflet custom styling */
        .leaflet-draw-toolbar a {
            background-color: var(--teal-accent) !important;
        }
        
        .leaflet-draw-actions a {
            background-color: #333 !important;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Map snapshot preview */
        #map-snapshot-preview {
            margin-top: var(--spacing-md);
            display: none;
        }
        
        #map-snapshot-preview img {
            max-width: 100%;
            border-radius: var(--radius-md);
            border: 2px solid var(--teal-accent);
        }
        
        #map-snapshot-preview .snapshot-label {
            font-size: 0.85rem;
            color: var(--slate);
            margin-top: var(--spacing-sm);
        }
        
        /* Responsive summary grid */
        @media (max-width: 768px) {
            .quote-summary > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <img src="images/Logos/re wall logo WHITE.png" alt="R:Wall Logo" style="width: 120px; height: auto; filter: drop-shadow(0 0 8px rgba(74, 144, 164, 0.8));">
        </div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="#services" class="active">Services</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="blog.html">Blog</a></li>
        </ul>
        
        <div class="divider"></div>
        
        <div class="cta-group">
            <button class="btn" onclick="window.location.href='contact.html'">Request a Quote</button>
            <button class="btn secondary" onclick="window.location.href='https://databloc.nz'">Plan Your Wall</button>
        </div>
        
        <div class="divider"></div>
        
        <ul>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>

    <button class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <main>
        <!-- Hero Section -->
        <section class="hero" id="services">
            <div class="content">
                <h1>Your Complete Journey</h1>
                <p class="subheadline"><strong>Pick One. Pick Many. Pick All.</strong> You're in control.</p>
                <p style="max-width: 700px; margin: 0 auto; color: var(--slate); font-size: 1rem;">From initial site planning to final sign-off, ReWall guides you through every step. Choose individual services or let us handle the complete journey.</p>
            </div>
        </section>

        <!-- Service Circle Diagram - MAIN FOCUS -->
        <section class="container" style="padding-top: var(--spacing-xl); padding-bottom: var(--spacing-xl);">
            <h2 style="text-align: center; margin-bottom: var(--spacing-md);">Complete the Circle</h2>
            <p style="text-align: center; color: var(--slate); margin-bottom: var(--spacing-lg);">Choose your path: Full service or Mix & Match</p>
            
            <!-- Service Options -->
            <div style="display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap; margin-bottom: var(--spacing-lg);">
                <button class="service-option-btn active" onclick="selectServiceMode('all')" data-mode="all">
                    ‚úì Complete Package
                </button>
                <button class="service-option-btn" onclick="selectServiceMode('custom')" data-mode="custom">
                    ‚úì Mix & Match
                </button>
            </div>
            
            <p style="text-align: center; max-width: 700px; margin: 0 auto var(--spacing-xl); font-size: 0.95rem; color: var(--slate); line-height: 1.6;">
                <strong>Complete Package:</strong> All 6 stages. Let us handle everything from planning to sign-off.
                <br><br>
                <strong>Mix & Match:</strong> Pick one stage, pick multiple stages, or pick all. Click the stages below to build the exact package you need. Perfect for any timeline and budget.
            </p>
            
            <div class="journey-circle-container">
                <!-- Center info box -->
                <div class="journey-center">
                    <div id="service-mode-display" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 8px;">‚úì Complete Journey</div>
                    <h3 id="stage-title">Complete the Circle</h3>
                    <p id="stage-description" style="font-size: 0.8rem;">Hover over any stage to learn more, or switch to Mix & Match mode to select specific stages</p>
                </div>
                
                <!-- Stage 1: Planning -->
                <div class="journey-stage" data-stage="1" data-title="Site Planning" data-description="We assess your site, measure dimensions, evaluate soil conditions, and identify opportunities. Our team creates an initial scope of work and timeline.">
                    <input type="checkbox" class="stage-checkbox" id="stage-1" data-stage="1">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-planning.svg" alt="Site Planning" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Site Planning</div>
                </div>
                
                <!-- Stage 2: Design -->
                <div class="journey-stage" data-stage="2" data-title="Engineering Design" data-description="Our Nemean-backed engineers create detailed designs, perform structural calculations, and produce technical drawings. All designs meet local building codes.">
                    <input type="checkbox" class="stage-checkbox" id="stage-2" data-stage="2">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-design.svg" alt="Engineering Design" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Design</div>
                </div>
                
                <!-- Stage 3: Estimate -->
                <div class="journey-stage" data-stage="3" data-title="Cost Estimate" data-description="Based on the design, we provide a detailed cost estimate including materials, labor, and timeline. We explain every line item so you know what you're paying for.">
                    <input type="checkbox" class="stage-checkbox" id="stage-3" data-stage="3">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-estimate.svg" alt="Cost Estimate" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Estimate</div>
                </div>
                
                <!-- Stage 4: Consent -->
                <div class="journey-stage" data-stage="4" data-title="Council Consent" data-description="Not sure if you need consent? Share your address and wall dimensions and we'll check requirements for your area. We handle all submissions, resource consents, and building permits.">
                    <input type="checkbox" class="stage-checkbox" id="stage-4" data-stage="4">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-consent.svg" alt="Council Consent" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Consent</div>
                </div>
                
                <!-- Stage 5: Construction -->
                <div class="journey-stage" data-stage="5" data-title="Construction" data-description="Our trusted construction partners execute the project with quality and safety. We provide oversight, inspections, and regular progress updates throughout.">
                    <input type="checkbox" class="stage-checkbox" id="stage-5" data-stage="5">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-construction.svg" alt="Construction" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Construction</div>
                </div>
                
                <!-- Stage 6: Sign-Off -->
                <div class="journey-stage" data-stage="6" data-title="Final Sign-Off" data-description="Once complete, we conduct final inspections, obtain sign-offs from authorities, and hand over the project to you with all documentation and warranties.">
                    <input type="checkbox" class="stage-checkbox" id="stage-6" data-stage="6">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-signoff.svg" alt="Final Sign-Off" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Sign-Off</div>
                </div>
            </div>
            
            <!-- Request a Quote Button -->
            <div style="text-align: center; margin-top: var(--spacing-xl);">
                <button id="continue-to-details-btn" class="btn" onclick="scrollToQuoteBuilder()">
                    Continue to Quote Builder ‚Üí
                </button>
            </div>
        </section>

        <!-- Quote Builder Section -->
        <section class="quote-builder" id="quote-builder">
            <div class="container">
                <div style="text-align: center; margin-bottom: var(--spacing-xxl);">
                    <h2>Build Your Quote</h2>
                    <p style="max-width: 700px; margin: 0 auto; color: var(--slate); font-size: 1.1rem;">
                        You're almost there! Complete the steps below to get an accurate quote. 
                        The more details you provide, the more precise your estimate will be.
                    </p>
                </div>

                <!-- Step 1: Services Selected (Summary from Circle) -->
                <div class="quote-step" id="step-services">
                    <div class="quote-step-header">
                        <div class="step-number" id="step1-number">1</div>
                        <h3>Services Selected</h3>
                    </div>
                    <p class="quote-step-description">
                        Your selected services from the journey circle above. 
                        <a href="#services" style="color: var(--teal-accent);">Go back to modify ‚Üë</a>
                    </p>
                    <div id="selected-services-summary" style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                        <span style="color: var(--slate); font-style: italic;">No services selected yet. Please select from the circle above.</span>
                    </div>
                </div>

                <!-- Step 2: Site Location & Wall Drawing -->
                <div class="quote-step" id="step-map">
                    <div class="quote-step-header">
                        <div class="step-number">2</div>
                        <h3>Mark Your Retaining Wall Location</h3>
                        <span class="optional-badge">Optional but Recommended</span>
                    </div>
                    <p class="quote-step-description">
                        üó∫Ô∏è <strong>Find your property and draw where you need retaining walls.</strong><br>
                        Search for your address, toggle property boundaries on, then use the drawing tool to mark wall locations. 
                        This helps us understand your site and provide a more accurate quote. You can draw multiple walls if needed.
                    </p>
                    
                    <div class="map-controls">
                        <div class="address-search">
                            <div class="address-search-wrapper">
                                <input type="text" id="address-input" placeholder="Start typing your NZ address..." autocomplete="off">
                                <button id="search-btn" onclick="selectFirstSuggestion()">üîç Search</button>
                            </div>
                            <div id="address-suggestions" class="address-suggestions"></div>
                        </div>
                        <div class="map-layer-toggle">
                            <button id="map-btn" class="active" onclick="setMapLayer('map')">Map</button>
                            <button id="satellite-btn" onclick="setMapLayer('satellite')">Satellite</button>
                        </div>
                    </div>
                    
                    <div class="layer-toggles" style="margin-bottom: var(--spacing-md);">
                        <label class="layer-toggle-item" id="boundaries-label" title="Show/hide NZ property boundary lines">
                            <input type="checkbox" id="boundaries-toggle" onchange="toggleBoundaries()">
                            <span>üè† Property Boundaries</span>
                        </label>
                        <label class="layer-toggle-item" id="contours-label" title="Show/hide topographic contour lines">
                            <input type="checkbox" id="contours-toggle" onchange="toggleContours()">
                            <span>üìà Contours</span>
                        </label>
                    </div>
                    
                    <div id="map-container">
                        <div id="site-map"></div>
                        <div class="draw-prompt-tooltip" id="draw-tooltip">
                            <span class="prompt-icon">üëÜ</span>
                            Click the drawing tool to mark your wall location!
                        </div>
                    </div>
                    
                    <div class="drawing-info">
                        <h4>üìè How to Draw Your Walls</h4>
                        <p>
                            <strong>1.</strong> Click the <span style="background: #4A90A4; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 600;">üìê Draw a polyline</span> tool on the left side of the map<br>
                            <strong>2.</strong> Click on the map to place points along your wall line<br>
                            <strong>3.</strong> Double-click or click "Finish" to complete the wall<br>
                            <strong>4.</strong> The distance will be calculated automatically<br>
                            <strong>5.</strong> Draw additional walls if needed - each will be tracked separately
                        </p>
                    </div>
                    
                    <div id="drawn-walls-container" class="drawn-walls-list" style="display: none;">
                        <h4>üß± Your Marked Walls</h4>
                        <div id="walls-list"></div>
                        <div id="total-length-display" class="total-length"></div>
                    </div>
                </div>

                <!-- Step 3: Wall Type Selection -->
                <div class="quote-step" id="step-wall-type">
                    <div class="quote-step-header">
                        <div class="step-number">3</div>
                        <h3>What Type of Retaining Wall?</h3>
                    </div>
                    <p class="quote-step-description">
                        Select the type(s) of retaining wall you're interested in. Not sure? Select multiple options 
                        and we'll help you choose the best solution for your site. Each type has different cost, 
                        aesthetic, and structural characteristics.
                    </p>
                    
                    <div class="wall-type-grid">
                        <div class="wall-type-option" onclick="toggleWallType(this, 'gravity')">
                            <input type="checkbox" id="wall-gravity" name="wall-type" value="Gravity (Concrete)">
                            <label for="wall-gravity">Gravity (Concrete)</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'hybrid')">
                            <input type="checkbox" id="wall-hybrid" name="wall-type" value="Hybrid">
                            <label for="wall-hybrid">Hybrid</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'landscape')">
                            <input type="checkbox" id="wall-landscape" name="wall-type" value="Landscape">
                            <label for="wall-landscape">Landscape</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'mse')">
                            <input type="checkbox" id="wall-mse" name="wall-type" value="MSE (Mechanically Stabilized Earth)">
                            <label for="wall-mse">MSE</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'timber')">
                            <input type="checkbox" id="wall-timber" name="wall-type" value="Timber">
                            <label for="wall-timber">Timber</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'other')">
                            <input type="checkbox" id="wall-other" name="wall-type" value="Other">
                            <label for="wall-other">Other</label>
                        </div>
                    </div>
                    <input type="text" id="other-wall-type" class="other-input" placeholder="Please describe the wall type you're looking for...">
                </div>

                <!-- Step 4: Geotechnical Report -->
                <div class="quote-step" id="step-geotech">
                    <div class="quote-step-header">
                        <div class="step-number">4</div>
                        <h3>Do You Have a Geotechnical Report?</h3>
                    </div>
                    <p class="quote-step-description">
                        üî¨ <strong>A geotechnical report helps us understand your soil conditions.</strong><br>
                        This information is essential for designing a safe, durable retaining wall. If you don't have one, we can arrange this as part of your project.
                    </p>
                    
                    <div class="geotech-options" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                        <label class="geotech-option" style="display: flex; align-items: flex-start; gap: var(--spacing-md); padding: var(--spacing-md); border: 2px solid var(--border-gray); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;" onclick="selectGeotechOption(this, 'have-report')">
                            <input type="radio" name="geotech-status" value="have-report" style="margin-top: 4px;">
                            <div>
                                <strong style="color: var(--charcoal);">‚úÖ Yes, I have a geotechnical report</strong>
                                <p style="margin: var(--spacing-xs) 0 0; color: var(--slate); font-size: 0.9rem;">Great! Please upload it in the documents section below, or send it to us via email.</p>
                            </div>
                        </label>
                        
                        <label class="geotech-option" style="display: flex; align-items: flex-start; gap: var(--spacing-md); padding: var(--spacing-md); border: 2px solid var(--border-gray); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;" onclick="selectGeotechOption(this, 'need-report')">
                            <input type="radio" name="geotech-status" value="need-report" style="margin-top: 4px;">
                            <div>
                                <strong style="color: var(--charcoal);">üìã No, please include geotechnical investigation in the quote</strong>
                                <p style="margin: var(--spacing-xs) 0 0; color: var(--slate); font-size: 0.9rem;">We'll arrange a site investigation to assess soil conditions and provide recommendations.</p>
                            </div>
                        </label>
                        
                        <label class="geotech-option" style="display: flex; align-items: flex-start; gap: var(--spacing-md); padding: var(--spacing-md); border: 2px solid var(--border-gray); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;" onclick="selectGeotechOption(this, 'not-sure')">
                            <input type="radio" name="geotech-status" value="not-sure" style="margin-top: 4px;">
                            <div>
                                <strong style="color: var(--charcoal);">‚ùì I'm not sure / Need advice</strong>
                                <p style="margin: var(--spacing-xs) 0 0; color: var(--slate); font-size: 0.9rem;">No problem! We'll assess your requirements and advise whether a geotech report is needed for your project.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Step 5: Your Details & Notes -->
                <div class="quote-step" id="step-details">
                    <div class="quote-step-header">
                        <div class="step-number">5</div>
                        <h3>Your Details & Project Notes</h3>
                    </div>
                    <p class="quote-step-description">
                        Tell us about yourself and your project. The more information you provide, the more accurate and helpful our response will be.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-md);">
                        <div>
                            <label for="client-name" style="display: block; font-weight: 600; margin-bottom: 8px;">Full Name *</label>
                            <input type="text" id="client-name" placeholder="Your full name" required style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                        <div>
                            <label for="client-email" style="display: block; font-weight: 600; margin-bottom: 8px;">Email Address *</label>
                            <input type="email" id="client-email" placeholder="your@email.com" required style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                        <div>
                            <label for="client-phone" style="display: block; font-weight: 600; margin-bottom: 8px;">Phone Number</label>
                            <input type="tel" id="client-phone" placeholder="021 123 4567" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                        <div>
                            <label for="client-company" style="display: block; font-weight: 600; margin-bottom: 8px;">Company/Project Name</label>
                            <input type="text" id="client-company" placeholder="Optional" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-lg);">
                        <label for="client-notes" style="display: block; font-weight: 600; margin-bottom: 8px;">üìù Project Notes & Questions</label>
                        <textarea id="client-notes" rows="5" placeholder="Tell us about your project... &#10;&#10;‚Ä¢ What's the purpose of the wall? &#10;‚Ä¢ Any specific materials you prefer?&#10;‚Ä¢ Timeline requirements?&#10;‚Ä¢ Budget range?&#10;‚Ä¢ Any access challenges to the site?&#10;‚Ä¢ Questions for our team?" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="margin-top: var(--spacing-lg);">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">üìé Attach Site Photos or Documents</label>
                        <p style="color: var(--slate); font-size: 0.9rem; margin-bottom: var(--spacing-sm);">Upload photos of your site, existing plans, or any relevant documents</p>
                        <p style="color: #e74c3c; font-size: 0.85rem; margin-bottom: var(--spacing-sm);"><strong>Limits:</strong> Max 5MB per file, up to 5 files. Accepted: Images (JPG, PNG), PDFs, Word docs</p>
                        <div id="file-upload-area" style="border: 2px dashed var(--border-gray); border-radius: var(--radius-md); padding: var(--spacing-xl); text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--light-gray);">
                            <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx" style="display: none;">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üìÅ</div>
                            <p style="margin: 0; font-weight: 500;">Drop files here or click to browse</p>
                            <p style="margin: var(--spacing-xs) 0 0; font-size: 0.85rem; color: var(--slate);">JPG, PNG, PDF, Word documents (max 5MB each)</p>
                        </div>
                        <div id="file-list" style="margin-top: var(--spacing-md);"></div>
                        <div id="file-size-warning" style="display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404; font-size: 0.9rem;"></div>
                    </div>
                </div>

                <!-- Quote Summary -->
                <div class="quote-summary" id="quote-summary">
                    <h3>üìã Your Quote Request Summary</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xl);">
                        <div>
                            <div class="summary-section">
                                <h4>Selected Services</h4>
                                <ul id="summary-services">
                                    <li style="color: rgba(255,255,255,0.6); font-style: italic;">None selected</li>
                                </ul>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Site Location</h4>
                                <p id="summary-location">Not specified</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Wall Measurements</h4>
                                <p id="summary-walls">No walls drawn</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Wall Types</h4>
                                <p id="summary-wall-types">None selected</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Geotechnical Report</h4>
                                <p id="summary-geotech">Not specified</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Contact Details</h4>
                                <p id="summary-contact">Not provided</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Attachments</h4>
                                <p id="summary-attachments">No files attached</p>
                            </div>
                        </div>
                        
                        <div>
                            <div class="summary-section">
                                <h4>Site Map Preview</h4>
                                <div id="map-snapshot-container" style="background: rgba(255,255,255,0.1); border-radius: var(--radius-md); padding: var(--spacing-md); min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <p id="snapshot-placeholder" style="color: rgba(255,255,255,0.5); text-align: center;">
                                        Map snapshot will appear here<br>when you mark wall locations<br><br>
                                        <span style="font-size: 0.85rem;">Click "Capture Snapshot" after drawing walls</span>
                                    </p>
                                    <img id="map-snapshot-img" style="max-width: 100%; border-radius: var(--radius-sm); display: none;">
                                </div>
                                <button id="capture-map-btn" onclick="manualCaptureSnapshot()" style="margin-top: var(--spacing-sm); padding: 10px 16px; background: var(--teal-accent); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; width: 100%; font-size: 0.9rem; font-weight: 600;">
                                    üì∏ Capture Map Snapshot
                                </button>
                                <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 8px; text-align: center;">Make sure your walls are visible on the map before capturing</p>
                            </div>
                            
                            <div class="summary-section" style="border-bottom: none;">
                                <h4>Project Notes</h4>
                                <p id="summary-notes" style="font-style: italic; opacity: 0.7;">No notes added</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid rgba(255,255,255,0.2);">
                        <div id="validation-message" style="display: none; background: #ff5252; color: white; padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md); text-align: center;">
                            Please fill in required fields (Name and Email)
                        </div>
                        
                        <button type="button" class="submit-quote-btn" id="submit-quote-btn" onclick="submitQuoteRequest()">
                            üöÄ Submit Quote Request
                        </button>
                        <p style="text-align: center; margin-top: var(--spacing-md); font-size: 0.9rem; opacity: 0.8;">
                            We'll review your request and get back to you within 24-48 hours with a detailed response.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Full-Service Solutions -->
        <section class="alt-bg">
            <div class="container">
                <h2 style="text-align: center;">Full-Service Solutions: Complete the Circle</h2>
                <p style="text-align: center; max-width: 700px; margin: 0 auto var(--spacing-xl);">Let us handle everything from initial consultation to final project sign-off. Choose all 6 stages or select the ones you need.</p>
                
                <div class="grid" style="grid-template-columns: repeat(2, 1fr); margin-top: var(--spacing-xl);">
                    <div class="card">
                        <h3>üìã Project Management</h3>
                        <p>We coordinate every aspect of your retaining wall project:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Initial site assessment</li>
                            <li>‚úì Scope definition & budgeting</li>
                            <li>‚úì Timeline planning</li>
                            <li>‚úì Stakeholder communication</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>üìê Engineering Design</h3>
                        <p>Expert structural and geotechnical engineering:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Wall type selection</li>
                            <li>‚úì Detailed design drawings</li>
                            <li>‚úì Soil analysis & calculations</li>
                            <li>‚úì Safety certifications</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>ÔøΩ Cost Estimation</h3>
                        <p>Transparent pricing based on your project scope:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Detailed cost breakdown</li>
                            <li>‚úì Materials & labor quotes</li>
                            <li>‚úì Timeline & budget planning</li>
                            <li>‚úì No hidden costs</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>üìú Council Consent</h3>
                        <p>Seamless consent and compliance process:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Resource consent preparation</li>
                            <li>‚úì Building consent documentation</li>
                            <li>‚úì Authority liaison & follow-up</li>
                            <li>‚úì Permit coordination</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>üèóÔ∏è Construction</h3>
                        <p>Quality construction execution with professional oversight:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Expert construction partners</li>
                            <li>‚úì Quality assurance inspections</li>
                            <li>‚úì Safety compliance</li>
                            <li>‚úì Regular progress updates</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>‚úì Final Sign-Off</h3>
                        <p>Complete project handover with full documentation:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Final inspections & testing</li>
                            <li>‚úì Authority sign-offs obtained</li>
                            <li>‚úì Complete documentation package</li>
                            <li>‚úì Warranty & maintenance guide</li>
                        </ul>
                    </div>
                </div>

                <div style="text-align: center; margin-top: var(--spacing-xl);">
                    <button class="btn" onclick="window.location.href='contact.html'">Request Full-Service Quote</button>
                </div>
            </div>
        </section>

        <!-- Retaining Wall Types -->
        <section class="container">
            <h2 style="text-align: center; margin-bottom: var(--spacing-xl);">Wall Types We Specialize In</h2>
            
            <div class="grid grid-2">
                <div class="card">
                    <h3>MSE/MSC Walls</h3>
                    <p><strong>Mechanically Stabilized Earth Walls</strong></p>
                    <p>High-performance solutions for large spans and heavy loads. Ideal for commercial and industrial applications.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Cost-effective for high walls</li>
                        <li>‚Ä¢ Excellent load-bearing capacity</li>
                        <li>‚Ä¢ Flexible design options</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Gravity Retaining Walls</h3>
                    <p><strong>Classic Concrete & Masonry</strong></p>
                    <p>Solid, reliable structures using the weight of the wall itself. Perfect for residential and smaller projects.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Simple, proven design</li>
                        <li>‚Ä¢ Minimal maintenance</li>
                        <li>‚Ä¢ Custom finishes available</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Timber Retaining Walls</h3>
                    <p><strong>Natural & Aesthetic</strong></p>
                    <p>Environmentally-friendly timber solutions that blend seamlessly with landscaping. Ideal for gardens and residential areas.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Natural appearance</li>
                        <li>‚Ä¢ Sustainable materials</li>
                        <li>‚Ä¢ Lower height restrictions</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Concrete Retaining Walls</h3>
                    <p><strong>Durable & Long-lasting</strong></p>
                    <p>Precast and cast-in-place concrete options for maximum durability and architectural flexibility.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Superior longevity</li>
                        <li>‚Ä¢ Design flexibility</li>
                        <li>‚Ä¢ Weather resistant</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Landscape/Garden Walls</h3>
                    <p><strong>Aesthetic Soil Retention</strong></p>
                    <p>Decorative solutions for smaller-scale projects that enhance landscape design while retaining soil.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Design-focused</li>
                        <li>‚Ä¢ Varied material options</li>
                        <li>‚Ä¢ Quick installation</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Custom Solutions</h3>
                    <p><strong>Tailored to Your Needs</strong></p>
                    <p>Unique projects require unique solutions. We design custom systems for complex site conditions.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Site-specific engineering</li>
                        <li>‚Ä¢ Innovative approaches</li>
                        <li>‚Ä¢ Specialized expertise</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Flexible Engagement -->
        <section class="alt-bg">
            <div class="container">
                <h2 style="text-align: center; margin-bottom: var(--spacing-md);">Flexible Engagement: Mix & Match Services</h2>
                <p style="text-align: center; max-width: 700px; margin: 0 auto var(--spacing-xl); color: var(--slate);">Not ready for the complete package? Choose the specific services you need right now. Perfect flexibility for your timeline and budget.</p>
                
                <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-top: var(--spacing-xl); gap: var(--spacing-lg);">
                    <div class="card" style="border-left: 5px solid var(--teal-accent); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--teal-accent);">üéØ Engineering Design Only</h3>
                        <p style="font-size: 0.95rem; color: var(--slate); margin-bottom: var(--spacing-md);"><strong>Perfect for:</strong> Builders with their own project management</p>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li>‚úì Complete structural design</li>
                            <li>‚úì Technical drawings & specs</li>
                            <li>‚úì Engineering certification</li>
                            <li>‚úì Consultation & support</li>
                        </ul>
                    </div>
                    <div class="card" style="border-left: 5px solid var(--teal-accent); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--teal-accent);">üìã Council Submission Support</h3>
                        <p style="font-size: 0.95rem; color: var(--slate); margin-bottom: var(--spacing-md);"><strong>Perfect for:</strong> Designers needing consent expertise</p>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li>‚úì Consent application prep</li>
                            <li>‚úì Authority liaison</li>
                            <li>‚úì Documentation support</li>
                            <li>‚úì Follow-up & amendments</li>
                        </ul>
                    </div>
                    <div class="card" style="border-left: 5px solid var(--teal-accent); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--teal-accent);">üèóÔ∏è Construction Supervision</h3>
                        <p style="font-size: 0.95rem; color: var(--slate); margin-bottom: var(--spacing-md);"><strong>Perfect for:</strong> Those managing their own design phase</p>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li>‚úì Quality inspections</li>
                            <li>‚úì Safety oversight</li>
                            <li>‚úì Progress monitoring</li>
                            <li>‚úì Final certification</li>
                        </ul>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: var(--spacing-xl);">
                    <button class="btn" onclick="window.location.href='contact.html'">Get a Custom Quote</button>
                </div>
            </div>
        </section>

        <!-- Service Selection Popup Modal -->
        <div id="service-popup" class="service-popup">
            <div class="service-popup-content">
                <button class="popup-close" onclick="closeServicePopup()">√ó</button>
                <h3>Ready to Get Started?</h3>
                <p id="popup-selection-summary" style="font-size: 1.1rem; margin: var(--spacing-md) 0; color: var(--slate);"></p>
                <p style="color: var(--slate); margin-bottom: var(--spacing-lg);">
                    Complete the next step by requesting a quote from our team. We'll review your selections and provide a detailed proposal.
                </p>
                <div style="display: flex; gap: var(--spacing-md); justify-content: center;">
                    <button class="btn" onclick="window.location.href='contact.html'">Request a Quote</button>
                    <button class="btn secondary" onclick="closeServicePopup()">Continue Browsing</button>
                </div>
            </div>
        </div>

        <!-- Future Tools -->
        <section class="container">
            <div class="card" style="background: linear-gradient(135deg, var(--soft-blue) 0%, #dbe8f0 100%); border-left: 4px solid var(--teal-accent);">
                <h3 style="color: var(--teal-accent);">üîÆ Coming Soon: DIY Planning Tool</h3>
                <p><strong>Transform the way you plan retaining walls</strong></p>
                <p>Our next-generation digital tool (powered by Data Bloc) will enable you to:</p>
                <ul style="list-style: none; padding: 0; columns: 2;">
                    <li>‚úì Visualize your wall in 3D</li>
                    <li>‚úì Run automated calculations</li>
                    <li>‚úì Generate preliminary scopes</li>
                    <li>‚úì Export pre-quote data</li>
                </ul>
                <p style="margin-top: var(--spacing-lg);"><em>Want early access? Contact us to join the beta program.</em></p>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-brand">
                        <img src="images/Logos/re wall logo WHITE.png" alt="ReWall Logo" style="width: 180px; height: auto; margin-bottom: var(--spacing-md);">
                        <p>Premium retaining wall solutions with expert engineering, smart digital tools, and trusted construction partners.</p>
                        <div class="footer-contact-inline">
                            <a href="mailto:Rewallsolutions@gmail.com">üìß Rewallsolutions@gmail.com</a>
                            <a href="tel:+64273941127">üìû 027 394 1127</a>
                        </div>
                    </div>
                    <div class="footer-links-group">
                        <div class="footer-col">
                            <h4>Quick Links</h4>
                            <ul>
                                <li><a href="index.html">Home</a></li>
                                <li><a href="about.html">About</a></li>
                                <li><a href="services.html">Services</a></li>
                                <li><a href="gallery.html">Gallery</a></li>
                                <li><a href="blog.html">Blog</a></li>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <h4>Services</h4>
                            <ul>
                                <li><a href="services.html">Full-Service Solutions</a></li>
                                <li><a href="services.html">Engineering Design</a></li>
                                <li><a href="services.html">Council Submissions</a></li>
                                <li><a href="services.html">Construction</a></li>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <h4>Get In Touch</h4>
                            <ul>
                                <li><a href="contact.html">Contact Form</a></li>
                                <li><a href="contact.html">Request a Quote</a></li>
                                <li><a href="https://databloc.nz" target="_blank">Plan Your Wall</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 ReWall NZ. All rights reserved. | <a href="#privacy">Privacy Policy</a></p>
            </div>
        </footer>
    </main>

    <script src="js/scripts.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- html2canvas for map snapshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- dom-to-image for better canvas capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    
    <!-- Quote Builder JavaScript -->
    <script>
        // ==========================================
        // QUOTE BUILDER - Interactive Map & Tools
        // ==========================================
        
        let map;
        let drawnItems;
        let drawControl;
        let currentLayer = 'map';
        let mapTileLayer;
        let satelliteTileLayer;
        let boundaryLayer;
        let contourLayer;
        let drawnWalls = [];
        let wallCounter = 0;
        let searchMarker;
        let selectedAddress = '';
        let selectedCoordinates = null;
        let mapSnapshot = null;
        let uploadedFiles = [];
        let searchTimeout = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if returning from FormSubmit submission
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('submitted') === 'true') {
                showSuccessMessage();
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            initializeMap();
            initializeAddressSearch();
            initializeFileUpload();
            updateQuoteSummary();
        });
        
        // Show success message after form submission
        function showSuccessMessage() {
            const modal = document.createElement('div');
            modal.id = 'success-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #28a745 0%, #20863a 100%); padding: 30px; border-radius: 16px 16px 0 0; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 10px;">‚úÖ</div>
                            <h2 style="color: white; margin: 0;">Quote Request Sent!</h2>
                        </div>
                        <div style="padding: 30px; text-align: center;">
                            <p style="font-size: 1.1rem; color: var(--primary-black); margin-bottom: 15px;">
                                <strong>Your quote request has been sent to ReWall!</strong>
                            </p>
                            <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #28a745; text-align: left;">
                                <p style="margin: 0 0 10px; color: #155724; font-weight: 600;">üìß What happens next:</p>
                                <ul style="margin: 0; padding-left: 20px; color: #155724;">
                                    <li>You'll receive a confirmation email shortly</li>
                                    <li>Our team will review your project details</li>
                                    <li>We'll contact you within 1-2 business days</li>
                                </ul>
                            </div>
                            <p style="color: var(--slate); margin-bottom: 20px;">
                                Questions? Call us at <a href="tel:+64273941127" style="color: var(--teal-accent); font-weight: 600;">027 394 1127</a>
                            </p>
                            <button onclick="document.getElementById('success-modal').remove();" style="padding: 14px 30px; background: var(--teal-accent); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Scroll to quote builder
        function scrollToQuoteBuilder() {
            document.getElementById('quote-builder').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        // ==========================================
        // ADDRESS SEARCH WITH AUTOCOMPLETE
        // ==========================================
        
        function initializeAddressSearch() {
            const input = document.getElementById('address-input');
            const suggestions = document.getElementById('address-suggestions');
            
            // Debounced search as user types
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    suggestions.classList.remove('active');
                    return;
                }
                
                // Show loading state
                suggestions.innerHTML = '<div class="address-searching">Searching...</div>';
                suggestions.classList.add('active');
                
                // Debounce the search
                searchTimeout = setTimeout(() => searchAddresses(query), 300);
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.address-search')) {
                    suggestions.classList.remove('active');
                }
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('.address-suggestion');
                const active = suggestions.querySelector('.address-suggestion.highlighted');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (active) {
                        active.classList.remove('highlighted');
                        const next = active.nextElementSibling;
                        if (next) next.classList.add('highlighted');
                        else items[0]?.classList.add('highlighted');
                    } else {
                        items[0]?.classList.add('highlighted');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (active) {
                        active.classList.remove('highlighted');
                        const prev = active.previousElementSibling;
                        if (prev) prev.classList.add('highlighted');
                        else items[items.length - 1]?.classList.add('highlighted');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (active) {
                        active.click();
                    } else if (items.length > 0) {
                        items[0].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestions.classList.remove('active');
                }
            });
        }
        
        async function searchAddresses(query) {
            const suggestions = document.getElementById('address-suggestions');
            
            try {
                // Use multiple search sources for better NZ coverage
                // LINZ Address API provides the most specific NZ addresses
                const searches = [
                    // LINZ NZ Address Locator - best for specific NZ addresses
                    fetch(`https://api.addressfinder.io/api/nz/address/autocomplete/?key=YPFNVGRTQDL9KE7MJAHU&q=${encodeURIComponent(query)}&max=8&format=json`).catch(() => null),
                    // Nominatim as backup with NZ focus and street-level detail
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=nz&limit=8&addressdetails=1&bounded=1&viewbox=166.0,-47.5,178.5,-34.0`),
                    // Photon (another geocoding service)
                    fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query + ' New Zealand')}&limit=5`)
                ];
                
                const [addressFinderRes, nominatimRes, photonRes] = await Promise.allSettled(searches);
                
                let results = [];
                
                // Process AddressFinder results first (most specific NZ addresses)
                if (addressFinderRes.status === 'fulfilled' && addressFinderRes.value) {
                    try {
                        const afData = await addressFinderRes.value.json();
                        if (afData.completions) {
                            for (const addr of afData.completions) {
                                // Get full address details with coordinates
                                try {
                                    const metaRes = await fetch(`https://api.addressfinder.io/api/nz/address/metadata/?key=YPFNVGRTQDL9KE7MJAHU&pxid=${addr.pxid}&format=json`);
                                    const meta = await metaRes.json();
                                    if (meta.x && meta.y) {
                                        results.push({
                                            display: addr.a,
                                            main: addr.a.split(',')[0],
                                            secondary: addr.a.split(',').slice(1).join(',').trim(),
                                            lat: parseFloat(meta.y),
                                            lon: parseFloat(meta.x),
                                            type: 'address',
                                            source: 'addressfinder'
                                        });
                                    }
                                } catch (e) {
                                    // If metadata fails, skip this result
                                }
                            }
                        }
                    } catch (e) {
                        console.log('AddressFinder parse error:', e);
                    }
                }
                
                // Process Nominatim results as backup
                if (nominatimRes.status === 'fulfilled' && results.length < 5) {
                    const nominatimData = await nominatimRes.value.json();
                    nominatimData.forEach(r => {
                        // Avoid duplicates and prioritize house/building addresses
                        const mainAddr = r.address?.house_number 
                            ? `${r.address.house_number} ${r.address.road || ''}`.trim()
                            : (r.name || r.display_name.split(',')[0]);
                        const secondaryAddr = [r.address?.suburb, r.address?.city || r.address?.town, r.address?.postcode].filter(Boolean).join(', ');
                        
                        if (!results.find(existing => existing.main === mainAddr)) {
                            results.push({
                                display: r.display_name,
                                main: mainAddr,
                                secondary: secondaryAddr || r.display_name.split(',').slice(1, 3).join(','),
                                lat: parseFloat(r.lat),
                                lon: parseFloat(r.lon),
                                type: r.type,
                                source: 'nominatim'
                            });
                        }
                    });
                }
                
                // Process Photon results (add unique ones)
                if (photonRes.status === 'fulfilled' && results.length < 5) {
                    try {
                        const photonData = await photonRes.value.json();
                        if (photonData.features) {
                            photonData.features.forEach(f => {
                                if (results.length < 8 && f.properties.country === 'New Zealand') {
                                    const main = f.properties.name || f.properties.street || '';
                                    const secondary = [f.properties.city, f.properties.state].filter(Boolean).join(', ');
                                    
                                    // Avoid duplicates
                                    if (!results.find(r => r.main === main && r.secondary === secondary)) {
                                        results.push({
                                            display: `${main}, ${secondary}, New Zealand`,
                                            main: main,
                                            secondary: secondary,
                                            lat: f.geometry.coordinates[1],
                                            lon: f.geometry.coordinates[0],
                                            type: f.properties.type,
                                            source: 'photon'
                                        });
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Photon parse error:', e);
                    }
                }
                
                if (results.length === 0) {
                    suggestions.innerHTML = '<div class="address-suggestion"><span class="suggestion-main">No results found</span><span class="suggestion-secondary">Try a different search term</span></div>';
                } else {
                    suggestions.innerHTML = results.map((r, i) => `
                        <div class="address-suggestion" data-lat="${r.lat}" data-lon="${r.lon}" data-display="${r.display}">
                            <div class="suggestion-main">${highlightMatch(r.main, document.getElementById('address-input').value)}</div>
                            <div class="suggestion-secondary">${r.secondary || ''}</div>
                        </div>
                    `).join('');
                    
                    // Add click handlers
                    suggestions.querySelectorAll('.address-suggestion').forEach(el => {
                        el.addEventListener('click', () => selectAddress(el));
                    });
                }
                
                suggestions.classList.add('active');
                
            } catch (error) {
                console.error('Address search error:', error);
                suggestions.innerHTML = '<div class="address-suggestion"><span class="suggestion-main">Search error</span><span class="suggestion-secondary">Please try again</span></div>';
            }
        }
        
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<strong style="color: var(--teal-accent);">$1</strong>');
        }
        
        function selectAddress(element) {
            const lat = parseFloat(element.dataset.lat);
            const lon = parseFloat(element.dataset.lon);
            const display = element.dataset.display;
            
            // Update input
            document.getElementById('address-input').value = display;
            document.getElementById('address-suggestions').classList.remove('active');
            
            // Store address
            selectedAddress = display;
            selectedCoordinates = { lat, lon };
            
            // Remove existing marker
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            // Add new marker with custom icon
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="font-size: 32px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));">üìç</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
            
            searchMarker = L.marker([lat, lon], { icon: markerIcon }).addTo(map);
            searchMarker.bindPopup(`<strong>Your Site</strong><br>${display}`).openPopup();
            
            // Zoom to location
            map.setView([lat, lon], 18);
            
            // Update summary
            updateQuoteSummary();
            
            // Auto-capture map after a short delay
            setTimeout(() => {
                if (drawnWalls.length > 0) {
                    captureMapSnapshot();
                }
            }, 1000);
        }
        
        function selectFirstSuggestion() {
            const firstSuggestion = document.querySelector('.address-suggestion');
            if (firstSuggestion) {
                selectAddress(firstSuggestion);
            } else {
                // If no suggestions, do a search
                const query = document.getElementById('address-input').value.trim();
                if (query.length >= 3) {
                    searchAddresses(query);
                }
            }
        }
        
        // ==========================================
        // LEAFLET MAP INITIALIZATION
        // ==========================================
        
        function initializeMap() {
            // Center on New Zealand - maxZoom 22 allows zooming very close to property level
            map = L.map('site-map', {
                center: [-41.2865, 174.7762],
                zoom: 6,
                zoomControl: true,
                maxZoom: 22
            });
            
            // Map tile layer (OpenStreetMap) - maxNativeZoom allows upscaling beyond tile resolution
            mapTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxNativeZoom: 19,
                maxZoom: 22
            });
            
            // Satellite tile layer (ESRI) - higher zoom with upscaling
            satelliteTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxNativeZoom: 19,
                maxZoom: 22
            });
            
            // LINZ Property Boundaries - NZ Property Titles (cadastral parcels)
            console.log('Initializing LINZ Property Boundaries...');
            boundaryLayer = L.tileLayer.wms('https://data.linz.govt.nz/services/key/c01j1rxmhp01hdh3v4j6ac5z1dv/wms?', {
                layers: 'layer-50804',
                format: 'image/png',
                transparent: true,
                attribution: '¬© LINZ CC BY 4.0',
                maxZoom: 22,
                minZoom: 14,
                opacity: 0.9,
                version: '1.3.0'
            });
            
            // LINZ Contour Lines - NZ 8m DEM Contours (2012-2016)
            console.log('Initializing LINZ Contours...');
            contourLayer = L.tileLayer.wms('https://data.linz.govt.nz/services/key/c01j1rxmhp01hdh3v4j6ac5z1dv/wms?', {
                layers: 'layer-50448',
                format: 'image/png',
                transparent: true,
                attribution: '¬© LINZ CC BY 4.0',
                maxZoom: 22,
                minZoom: 13,
                opacity: 0.8,
                version: '1.3.0'
            });
            
            // Start with map view
            mapTileLayer.addTo(map);
            
            // Initialize drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Add drawing controls
            drawControl = new L.Control.Draw({
                position: 'topleft',
                edit: {
                    featureGroup: drawnItems,
                    remove: true,
                    edit: true
                },
                draw: {
                    polygon: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false,
                    marker: false,
                    polyline: {
                        shapeOptions: {
                            color: '#e74c3c',
                            weight: 5,
                            opacity: 0.9
                        },
                        metric: true,
                        showLength: true,
                        feet: false
                    }
                }
            });
            map.addControl(drawControl);
            
            // Enhanced drawing tool interactions
            const drawTooltip = document.getElementById('draw-tooltip');
            let tooltipHidden = false;
            
            // Hide tooltip when user starts drawing
            map.on('draw:drawstart', function() {
                if (!tooltipHidden) {
                    drawTooltip.classList.add('hidden');
                    tooltipHidden = true;
                }
            });
            
            // Show encouraging message when first wall is drawn
            let firstWallDrawn = false;
            map.on('draw:created', function(e) {
                if (!firstWallDrawn) {
                    firstWallDrawn = true;
                    // Show success message briefly
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 20px rgba(40,167,69,0.4); z-index: 1001; animation: slideDown 0.3s ease;';
                    successMsg.textContent = '‚úÖ Great! Wall marked successfully!';
                    document.getElementById('map-container').appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                }
            });
            
            // Handle draw events
            map.on('draw:created', handleDrawCreated);
            map.on('draw:deleted', handleDrawDeleted);
            map.on('draw:edited', handleDrawEdited);
        }
        
        // Toggle map layers
        function setMapLayer(type) {
            console.log('Switching to ' + type + ' view');
            
            // Remove both base layers first
            if (map.hasLayer(mapTileLayer)) {
                map.removeLayer(mapTileLayer);
            }
            if (map.hasLayer(satelliteTileLayer)) {
                map.removeLayer(satelliteTileLayer);
            }
            
            if (type === 'map') {
                mapTileLayer.addTo(map);
                // Bring to back so overlays show on top
                mapTileLayer.bringToBack();
                document.getElementById('map-btn').classList.add('active');
                document.getElementById('satellite-btn').classList.remove('active');
                console.log('‚úì Map view activated');
            } else if (type === 'satellite') {
                satelliteTileLayer.addTo(map);
                satelliteTileLayer.bringToBack();
                document.getElementById('satellite-btn').classList.add('active');
                document.getElementById('map-btn').classList.remove('active');
                console.log('‚úì Satellite view activated');
            }
            currentLayer = type;
        }
        
        // Toggle property boundaries with enhanced feedback
        function toggleBoundaries() {
            const checkbox = document.getElementById('boundaries-toggle');
            const label = document.getElementById('boundaries-label');
            
            if (checkbox.checked) {
                try {
                    console.log('Adding property boundaries layer...');
                    console.log('Current map zoom:', map.getZoom());
                    console.log('Current map center:', map.getCenter());
                    
                    if (map.getZoom() < 14) {
                        alert('Please zoom in closer (zoom level 14+) to see property boundaries.');
                        checkbox.checked = false;
                        return;
                    }
                    
                    boundaryLayer.addTo(map);
                    // Keep boundaries above base layer but below drawn items
                    boundaryLayer.bringToFront();
                    if (drawnItems) {
                        drawnItems.bringToFront();
                    }
                    label.classList.add('active');
                    console.log('‚úì Property boundaries layer added successfully');
                    
                    // Add load event listener
                    boundaryLayer.on('loading', function() {
                        console.log('Loading boundaries tiles...');
                    });
                    boundaryLayer.on('load', function() {
                        console.log('‚úì Boundaries tiles loaded');
                    });
                    boundaryLayer.on('tileerror', function(error) {
                        console.error('Boundary tile error:', error);
                    });
                } catch (error) {
                    console.error('Error adding boundaries:', error);
                    checkbox.checked = false;
                    alert('Unable to load property boundaries. Error: ' + error.message);
                }
            } else {
                map.removeLayer(boundaryLayer);
                label.classList.remove('active');
                console.log('Property boundaries removed');
            }
        }
        
        // Toggle contour lines with enhanced feedback
        function toggleContours() {
            const checkbox = document.getElementById('contours-toggle');
            const label = document.getElementById('contours-label');
            
            if (checkbox.checked) {
                try {
                    console.log('Adding contours layer...');
                    console.log('Current map zoom:', map.getZoom());
                    console.log('Current map center:', map.getCenter());
                    
                    if (map.getZoom() < 13) {
                        alert('Please zoom in closer (zoom level 13+) to see contour lines.');
                        checkbox.checked = false;
                        return;
                    }
                    
                    contourLayer.addTo(map);
                    // Keep contours above base layer but below boundaries and drawn items
                    if (document.getElementById('boundaries-toggle').checked) {
                        boundaryLayer.bringToFront();
                    }
                    if (drawnItems) {
                        drawnItems.bringToFront();
                    }
                    label.classList.add('active');
                    console.log('‚úì Contours layer added successfully');
                    
                    // Add load event listeners
                    contourLayer.on('loading', function() {
                        console.log('Loading contour tiles...');
                    });
                    contourLayer.on('load', function() {
                        console.log('‚úì Contour tiles loaded');
                    });
                    contourLayer.on('tileerror', function(error) {
                        console.error('Contour tile error:', error);
                    });
                } catch (error) {
                    console.error('Error adding contours:', error);
                    checkbox.checked = false;
                    alert('Unable to load contour lines. Error: ' + error.message);
                }
            } else {
                map.removeLayer(contourLayer);
                label.classList.remove('active');
                console.log('Contours removed');
            }
        }
                    alert('Unable to load contour lines. Error: ' + error.message);
                }
            } else {
                map.removeLayer(contourLayer);
                label.classList.remove('active');
            }
        }
        
        // ==========================================
        // WALL DRAWING FUNCTIONS
        // ==========================================
        
        function handleDrawCreated(e) {
            const layer = e.layer;
            wallCounter++;
            
            // Calculate length
            const latlngs = layer.getLatLngs();
            const distance = calculateTotalDistance(latlngs);
            
            // Store wall data
            layer.wallId = wallCounter;
            layer.wallDistance = distance;
            drawnWalls.push({
                id: wallCounter,
                layer: layer,
                distance: distance,
                latlngs: latlngs.map(ll => ({ lat: ll.lat, lng: ll.lng }))
            });
            
            // Add styled popup
            layer.bindPopup(`
                <div style="text-align: center;">
                    <strong style="color: #e74c3c;">Wall #${wallCounter}</strong><br>
                    <span style="font-size: 1.2em; font-weight: bold;">~${formatDistance(distance)}</span>
                    <span style="font-size: 0.75em; color: #666;">(est.)</span>
                </div>
            `);
            
            // Add to map
            drawnItems.addLayer(layer);
            
            // Update UI
            updateWallsList();
            updateQuoteSummary();
            
            // Show walls container
            document.getElementById('drawn-walls-container').style.display = 'block';
            
            // Auto-capture map snapshot
            setTimeout(() => captureMapSnapshot(), 500);
        }
        
        function handleDrawDeleted(e) {
            e.layers.eachLayer(function(layer) {
                drawnWalls = drawnWalls.filter(w => w.layer !== layer);
            });
            updateWallsList();
            updateQuoteSummary();
            
            if (drawnWalls.length === 0) {
                document.getElementById('drawn-walls-container').style.display = 'none';
                document.getElementById('snapshot-placeholder').style.display = 'block';
                document.getElementById('map-snapshot-img').style.display = 'none';
            } else {
                captureMapSnapshot();
            }
        }
        
        function handleDrawEdited(e) {
            e.layers.eachLayer(function(layer) {
                const latlngs = layer.getLatLngs();
                const distance = calculateTotalDistance(latlngs);
                layer.wallDistance = distance;
                layer.setPopupContent(`
                    <div style="text-align: center;">
                        <strong style="color: #e74c3c;">Wall #${layer.wallId}</strong><br>
                        <span style="font-size: 1.2em; font-weight: bold;">~${formatDistance(distance)}</span>
                        <span style="font-size: 0.75em; color: #666;">(est.)</span>
                    </div>
                `);
                
                const wall = drawnWalls.find(w => w.layer === layer);
                if (wall) {
                    wall.distance = distance;
                    wall.latlngs = latlngs.map(ll => ({ lat: ll.lat, lng: ll.lng }));
                }
            });
            updateWallsList();
            updateQuoteSummary();
            captureMapSnapshot();
        }
        
        function calculateTotalDistance(latlngs) {
            let total = 0;
            for (let i = 0; i < latlngs.length - 1; i++) {
                total += latlngs[i].distanceTo(latlngs[i + 1]);
            }
            return total;
        }
        
        function formatDistance(meters) {
            if (meters >= 1000) {
                return (meters / 1000).toFixed(2) + ' km';
            }
            return meters.toFixed(1) + ' m';
        }
        
        function updateWallsList() {
            const container = document.getElementById('walls-list');
            const totalDisplay = document.getElementById('total-length-display');
            
            if (drawnWalls.length === 0) {
                container.innerHTML = '<p style="color: var(--slate); font-style: italic;">No walls drawn yet</p>';
                totalDisplay.innerHTML = '';
                return;
            }
            
            let html = '';
            let totalLength = 0;
            
            drawnWalls.forEach((wall) => {
                totalLength += wall.distance;
                const currentHeight = wall.height || '';
                html += `
                    <div class="wall-item" style="background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #e74c3c; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px;">
                            <span><strong>Wall #${wall.id}</strong></span>
                            <span style="color: var(--teal-accent); font-weight: 600; font-size: 1.1rem;">~${formatDistance(wall.distance)} <span style="font-size: 0.75rem; color: var(--slate);">(est.)</span></span>
                            <button onclick="focusOnWall(${wall.id})" style="background: var(--teal-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üìç View</button>
                        </div>
                        <div style="padding: 8px 12px 12px; background: var(--light-gray); border-top: 1px solid var(--border-gray);">
                            <label style="display: flex; align-items: center; gap: 10px; font-size: 0.9rem;">
                                <span style="color: var(--slate);">üìè Est. Height:</span>
                                <input type="number" 
                                    id="wall-height-${wall.id}" 
                                    value="${currentHeight}" 
                                    placeholder="e.g. 1.5" 
                                    min="0.1" 
                                    max="20" 
                                    step="0.1"
                                    onchange="updateWallHeight(${wall.id}, this.value)"
                                    style="width: 70px; padding: 6px 8px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 0.9rem; text-align: center;">
                                <span style="color: var(--slate);">metres</span>
                            </label>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            totalDisplay.innerHTML = `<strong>Est. Total Length:</strong> ~${formatDistance(totalLength)}<br><span style="font-size: 0.8rem; opacity: 0.9;">*Approximate only - actual measurements may vary</span>`;
        }
        
        function updateWallHeight(wallId, height) {
            const wall = drawnWalls.find(w => w.id === wallId);
            if (wall) {
                wall.height = parseFloat(height) || null;
                updateQuoteSummary();
            }
        }
        
        function focusOnWall(wallId) {
            const wall = drawnWalls.find(w => w.id === wallId);
            if (wall) {
                map.fitBounds(wall.layer.getBounds(), { padding: [50, 50] });
                wall.layer.openPopup();
            }
        }
        
        // ==========================================
        // MAP SNAPSHOT - Simple version
        // ==========================================
        
        // Helper functions for tile calculations
        function lng2tile(lng, zoom) { return Math.floor((lng + 180) / 360 * Math.pow(2, zoom)); }
        function lat2tile(lat, zoom) { return Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom)); }
        function tile2lng(x, zoom) { return x / Math.pow(2, zoom) * 360 - 180; }
        function tile2lat(y, zoom) { const n = Math.PI - 2 * Math.PI * y / Math.pow(2, zoom); return 180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n))); }
        
        async function captureMapSnapshot() {
            const placeholder = document.getElementById('snapshot-placeholder');
            const snapshotImg = document.getElementById('map-snapshot-img');
            
            console.log('Capturing map snapshot with satellite tiles...');
            
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Calculate bounds for walls or use map bounds
            let minLat, maxLat, minLng, maxLng;
            const bounds = map.getBounds();
            
            if (drawnWalls.length > 0) {
                minLat = Infinity; maxLat = -Infinity;
                minLng = Infinity; maxLng = -Infinity;
                
                drawnWalls.forEach(wall => {
                    let latlngs = wall.layer.getLatLngs();
                    if (latlngs[0] && Array.isArray(latlngs[0]) && !latlngs[0].lat) {
                        latlngs = latlngs[0];
                    }
                    latlngs.forEach(ll => {
                        minLat = Math.min(minLat, ll.lat);
                        maxLat = Math.max(maxLat, ll.lat);
                        minLng = Math.min(minLng, ll.lng);
                        maxLng = Math.max(maxLng, ll.lng);
                    });
                });
                
                // Add padding
                const latPad = (maxLat - minLat) * 0.5 || 0.0008;
                const lngPad = (maxLng - minLng) * 0.5 || 0.0008;
                minLat -= latPad; maxLat += latPad;
                minLng -= lngPad; maxLng += lngPad;
            } else {
                minLat = bounds.getSouth();
                maxLat = bounds.getNorth();
                minLng = bounds.getWest();
                maxLng = bounds.getEast();
            }
            
            // Determine zoom level for tiles (18 gives good detail)
            const zoom = 18;
            
            // Get tile coordinates
            const minTileX = lng2tile(minLng, zoom);
            const maxTileX = lng2tile(maxLng, zoom);
            const minTileY = lat2tile(maxLat, zoom); // Note: Y is inverted
            const maxTileY = lat2tile(minLat, zoom);
            
            // Calculate actual bounds from tiles
            const tileBoundsWest = tile2lng(minTileX, zoom);
            const tileBoundsEast = tile2lng(maxTileX + 1, zoom);
            const tileBoundsNorth = tile2lat(minTileY, zoom);
            const tileBoundsSouth = tile2lat(maxTileY + 1, zoom);
            
            // Tile size
            const tileSize = 256;
            const tilesX = maxTileX - minTileX + 1;
            const tilesY = maxTileY - minTileY + 1;
            
            // Create temp canvas for tiles
            const tileCanvas = document.createElement('canvas');
            tileCanvas.width = tilesX * tileSize;
            tileCanvas.height = tilesY * tileSize;
            const tileCtx = tileCanvas.getContext('2d');
            
            // Fill with dark background first
            tileCtx.fillStyle = '#2d4a2d';
            tileCtx.fillRect(0, 0, tileCanvas.width, tileCanvas.height);
            
            console.log(`Loading ${tilesX * tilesY} satellite tiles...`);
            
            // Load all tiles
            const tilePromises = [];
            for (let x = minTileX; x <= maxTileX; x++) {
                for (let y = minTileY; y <= maxTileY; y++) {
                    const tileUrl = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;
                    
                    const promise = new Promise((resolve) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => {
                            const destX = (x - minTileX) * tileSize;
                            const destY = (y - minTileY) * tileSize;
                            tileCtx.drawImage(img, destX, destY, tileSize, tileSize);
                            resolve(true);
                        };
                        img.onerror = () => {
                            console.log(`Tile ${x},${y} failed`);
                            resolve(false);
                        };
                        img.src = tileUrl;
                    });
                    tilePromises.push(promise);
                }
            }
            
            // Wait for all tiles
            const results = await Promise.all(tilePromises);
            const loadedCount = results.filter(r => r).length;
            console.log(`Loaded ${loadedCount}/${results.length} tiles`);
            
            // Now draw the relevant portion onto our 600x400 canvas
            // Calculate pixel coordinates for our bounds within the tile canvas
            const pxPerDegLng = tileCanvas.width / (tileBoundsEast - tileBoundsWest);
            const pxPerDegLat = tileCanvas.height / (tileBoundsNorth - tileBoundsSouth);
            
            const srcX = (minLng - tileBoundsWest) * pxPerDegLng;
            const srcY = (tileBoundsNorth - maxLat) * pxPerDegLat;
            const srcW = (maxLng - minLng) * pxPerDegLng;
            const srcH = (maxLat - minLat) * pxPerDegLat;
            
            // Draw cropped satellite imagery to final canvas
            ctx.drawImage(tileCanvas, srcX, srcY, srcW, srcH, 0, 0, 600, 400);
            
            // Scale functions for drawing walls
            const scaleX = (lng) => ((lng - minLng) / (maxLng - minLng)) * 600;
            const scaleY = (lat) => 400 - ((lat - minLat) / (maxLat - minLat)) * 400;
            
            // Draw walls on top of satellite background
            if (drawnWalls.length > 0) {
                drawnWalls.forEach((wall, idx) => {
                    let latlngs = wall.layer.getLatLngs();
                    if (latlngs[0] && Array.isArray(latlngs[0]) && !latlngs[0].lat) {
                        latlngs = latlngs[0];
                    }
                    
                    if (latlngs.length >= 2) {
                        // White outline for visibility on satellite
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 8;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.beginPath();
                        ctx.moveTo(scaleX(latlngs[0].lng), scaleY(latlngs[0].lat));
                        for (let i = 1; i < latlngs.length; i++) {
                            ctx.lineTo(scaleX(latlngs[i].lng), scaleY(latlngs[i].lat));
                        }
                        ctx.stroke();
                        
                        // Red wall line
                        ctx.strokeStyle = '#FF0000';
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.moveTo(scaleX(latlngs[0].lng), scaleY(latlngs[0].lat));
                        for (let i = 1; i < latlngs.length; i++) {
                            ctx.lineTo(scaleX(latlngs[i].lng), scaleY(latlngs[i].lat));
                        }
                        ctx.stroke();
                        
                        // Dots at vertices
                        latlngs.forEach(ll => {
                            ctx.fillStyle = '#ffffff';
                            ctx.beginPath();
                            ctx.arc(scaleX(ll.lng), scaleY(ll.lat), 8, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.fillStyle = '#FF0000';
                            ctx.beginPath();
                            ctx.arc(scaleX(ll.lng), scaleY(ll.lat), 5, 0, Math.PI * 2);
                            ctx.fill();
                        });
                        
                        // Label with background
                        const midIdx = Math.floor(latlngs.length / 2);
                        const midPt = latlngs[midIdx];
                        const labelX = scaleX(midPt.lng);
                        const labelY = scaleY(midPt.lat) - 20;
                        const label = 'Wall #' + (idx + 1);
                        
                        ctx.font = 'bold 14px Arial';
                        const textWidth = ctx.measureText(label).width;
                        
                        ctx.fillStyle = 'rgba(0,0,0,0.8)';
                        ctx.fillRect(labelX - textWidth/2 - 6, labelY - 12, textWidth + 12, 20);
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, labelX, labelY + 2);
                    }
                });
            }
            
            // Legend box
            ctx.fillStyle = 'rgba(0,0,0,0.75)';
            ctx.fillRect(10, 10, 150, 30);
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(20, 25);
            ctx.lineTo(55, 25);
            ctx.stroke();
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('= Wall location', 65, 29);
            
            // Address bar at bottom
            const addr = document.getElementById('address-search')?.value || '';
            if (addr) {
                ctx.fillStyle = 'rgba(0,0,0,0.75)';
                ctx.fillRect(0, 365, 600, 35);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('üìç ' + addr.substring(0, 70), 10, 387);
            }
            
            // Save snapshot
            mapSnapshot = canvas.toDataURL('image/png');
            snapshotImg.src = mapSnapshot;
            snapshotImg.style.display = 'block';
            placeholder.style.display = 'none';
            
            console.log('Snapshot complete with satellite background');
        }
        
        // Manual capture with visual feedback
        async function manualCaptureSnapshot() {
            const btn = document.getElementById('capture-map-btn');
            
            btn.innerHTML = '‚è≥ Capturing...';
            btn.disabled = true;
            
            // Just capture immediately - simple!
            captureMapSnapshot();
            
            // Show success
            btn.innerHTML = '‚úì Captured!';
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.innerHTML = 'üì∏ Update Map Snapshot';
                btn.style.background = '';
                btn.disabled = false;
            }, 1500);
        }
        
        // ==========================================
        // FILE UPLOAD
        // ==========================================
        
        function initializeFileUpload() {
            const uploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('file-input');
            
            // Click to upload
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--teal-accent)';
                uploadArea.style.background = 'var(--soft-blue)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--border-gray)';
                uploadArea.style.background = 'var(--light-gray)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border-gray)';
                uploadArea.style.background = 'var(--light-gray)';
                handleFiles(e.dataTransfer.files);
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }
        
        function handleFiles(files) {
            const maxFiles = 5;
            const maxSize = 5 * 1024 * 1024; // 5MB per file for FormSubmit
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const warningEl = document.getElementById('file-size-warning');
            
            Array.from(files).forEach(file => {
                // Check max files
                if (uploadedFiles.length >= maxFiles) {
                    alert(`Maximum ${maxFiles} files allowed. Please remove a file first.`);
                    return;
                }
                
                // Check file type
                if (!allowedTypes.includes(file.type)) {
                    alert(`${file.name} is not a supported file type.\n\nAccepted: JPG, PNG, GIF, PDF, DOC, DOCX`);
                    return;
                }
                
                // Check file size (5MB limit for FormSubmit)
                if (file.size > maxSize) {
                    alert(`${file.name} is too large (${(file.size / 1024 / 1024).toFixed(1)}MB).\n\nMaximum size is 5MB per file.\n\nTip: Compress images or use a PDF optimizer.`);
                    return;
                }
                
                // Store actual File object for FormSubmit (not base64)
                uploadedFiles.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    file: file // Store the actual File object
                });
                updateFileList();
                updateQuoteSummary();
            });
            
            // Show total size warning if getting close
            const totalSize = uploadedFiles.reduce((sum, f) => sum + f.size, 0);
            if (totalSize > 15 * 1024 * 1024) {
                warningEl.innerHTML = `‚ö†Ô∏è Total files: ${(totalSize / 1024 / 1024).toFixed(1)}MB. Large submissions may be slow.`;
                warningEl.style.display = 'block';
            } else {
                warningEl.style.display = 'none';
            }
        }
        
        function updateFileList() {
            const container = document.getElementById('file-list');
            
            if (uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = uploadedFiles.map((file, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--soft-blue); border-radius: 8px; margin-bottom: 8px;">
                    <span>
                        ${file.type.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ'} 
                        <strong>${file.name}</strong> 
                        <span style="color: var(--slate); font-size: 0.85rem;">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </span>
                    <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">‚úï</button>
                </div>
            `).join('');
        }
        
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            updateQuoteSummary();
        }
        
        // ==========================================
        // WALL TYPE SELECTION
        // ==========================================
        
        function toggleWallType(element, type) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
            
            if (type === 'other') {
                const otherInput = document.getElementById('other-wall-type');
                otherInput.style.display = checkbox.checked ? 'block' : 'none';
                if (checkbox.checked) {
                    otherInput.focus();
                }
            }
            
            updateQuoteSummary();
        }
        
        // ==========================================
        // GEOTECHNICAL OPTION SELECTION
        // ==========================================
        
        function selectGeotechOption(element, value) {
            // Remove selected class from all options
            document.querySelectorAll('.geotech-option').forEach(opt => {
                opt.style.borderColor = 'var(--border-gray)';
                opt.style.background = 'white';
            });
            
            // Add selected styling to clicked option
            element.style.borderColor = 'var(--teal-accent)';
            element.style.background = 'rgba(74, 144, 164, 0.05)';
            
            // Check the radio button
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;
            
            updateQuoteSummary();
        }
        
        // ==========================================
        // QUOTE SUMMARY UPDATE
        // ==========================================
        
        function updateQuoteSummary() {
            // Services
            const servicesContainer = document.getElementById('summary-services');
            const selectedServicesSummary = document.getElementById('selected-services-summary');
            const stages = document.querySelectorAll('.stage-checkbox:checked');
            const stageNames = {
                '1': 'Site Planning',
                '2': 'Engineering Design',
                '3': 'Cost Estimate',
                '4': 'Council Consent',
                '5': 'Construction',
                '6': 'Final Sign-Off'
            };
            
            if (stages.length > 0) {
                let servicesHtml = '';
                let summaryHtml = '';
                stages.forEach(stage => {
                    const stageNum = stage.dataset.stage;
                    const name = stageNames[stageNum] || `Stage ${stageNum}`;
                    servicesHtml += `<li>‚úì ${name}</li>`;
                    summaryHtml += `<span class="service-tag">${name}</span>`;
                });
                servicesContainer.innerHTML = servicesHtml;
                if (selectedServicesSummary) {
                    selectedServicesSummary.innerHTML = summaryHtml;
                }
                
                const step1Number = document.getElementById('step1-number');
                if (step1Number) {
                    step1Number.innerHTML = '‚úì';
                    step1Number.style.background = '#28a745';
                }
            } else {
                servicesContainer.innerHTML = '<li style="color: rgba(255,255,255,0.6); font-style: italic;">None selected</li>';
                if (selectedServicesSummary) {
                    selectedServicesSummary.innerHTML = '<span style="color: var(--slate); font-style: italic;">No services selected yet. Please select from the circle above.</span>';
                }
            }
            
            // Location
            const locationDisplay = document.getElementById('summary-location');
            locationDisplay.textContent = selectedAddress || 'Not specified';
            
            // Walls
            const wallsDisplay = document.getElementById('summary-walls');
            if (drawnWalls.length > 0) {
                let totalLength = drawnWalls.reduce((sum, w) => sum + w.distance, 0);
                let wallDetails = drawnWalls.map(w => {
                    const heightStr = w.height ? ` √ó ${w.height}m high` : '';
                    return `Wall #${w.id}: ~${formatDistance(w.distance)}${heightStr}`;
                }).join('<br>');
                wallsDisplay.innerHTML = `${drawnWalls.length} wall(s) marked:<br><span style="font-size: 0.9rem;">${wallDetails}</span><br><strong style="margin-top: 8px; display: inline-block;">Est. Total Length: ~${formatDistance(totalLength)}</strong><br><span style="font-size: 0.8rem; opacity: 0.7;">*Approximate measurements</span>`;
            } else {
                wallsDisplay.textContent = 'No walls drawn';
            }
            
            // Wall types
            const wallTypesDisplay = document.getElementById('summary-wall-types');
            const selectedWallTypes = [];
            document.querySelectorAll('.wall-type-option input:checked').forEach(input => {
                if (input.id !== 'wall-other') {
                    selectedWallTypes.push(input.value);
                }
            });
            
            if (document.getElementById('wall-other')?.checked) {
                const otherValue = document.getElementById('other-wall-type').value;
                if (otherValue) {
                    selectedWallTypes.push(`Other: ${otherValue}`);
                } else {
                    selectedWallTypes.push('Other (not specified)');
                }
            }
            
            wallTypesDisplay.textContent = selectedWallTypes.length > 0 ? selectedWallTypes.join(', ') : 'None selected';
            
            // Geotechnical Report Status
            const geotechDisplay = document.getElementById('summary-geotech');
            const geotechSelection = document.querySelector('input[name="geotech-status"]:checked');
            if (geotechSelection) {
                const geotechLabels = {
                    'have-report': '‚úÖ Has existing report',
                    'need-report': 'üìã Include in quote',
                    'not-sure': '‚ùì Needs advice'
                };
                geotechDisplay.textContent = geotechLabels[geotechSelection.value] || 'Not specified';
            } else {
                geotechDisplay.textContent = 'Not specified';
            }
            
            // Contact details
            const contactDisplay = document.getElementById('summary-contact');
            const name = document.getElementById('client-name')?.value || '';
            const email = document.getElementById('client-email')?.value || '';
            const phone = document.getElementById('client-phone')?.value || '';
            
            if (name || email) {
                contactDisplay.innerHTML = `
                    ${name ? `<strong>${name}</strong><br>` : ''}
                    ${email ? `üìß ${email}<br>` : ''}
                    ${phone ? `üìû ${phone}` : ''}
                `;
            } else {
                contactDisplay.textContent = 'Not provided';
            }
            
            // Attachments
            const attachmentsDisplay = document.getElementById('summary-attachments');
            if (uploadedFiles.length > 0) {
                attachmentsDisplay.textContent = `${uploadedFiles.length} file(s) attached`;
            } else {
                attachmentsDisplay.textContent = 'No files attached';
            }
            
            // Notes
            const notesDisplay = document.getElementById('summary-notes');
            const notes = document.getElementById('client-notes')?.value || '';
            if (notes) {
                notesDisplay.textContent = notes.length > 200 ? notes.substring(0, 200) + '...' : notes;
                notesDisplay.style.fontStyle = 'normal';
            } else {
                notesDisplay.textContent = 'No notes added';
                notesDisplay.style.fontStyle = 'italic';
            }
        }
        
        // Listen for form field changes
        document.addEventListener('DOMContentLoaded', function() {
            // Service checkboxes
            document.querySelectorAll('.stage-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateQuoteSummary);
            });
            
            // Client detail inputs
            ['client-name', 'client-email', 'client-phone', 'client-company', 'client-notes', 'other-wall-type'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateQuoteSummary);
                }
            });
        });
        
        // ==========================================
        // SUBMIT QUOTE REQUEST
        // ==========================================
        
        function submitQuoteRequest() {
            console.log('Submit button clicked - starting submitQuoteRequest');
            
            // Validate required fields
            const name = document.getElementById('client-name')?.value?.trim() || '';
            const email = document.getElementById('client-email')?.value?.trim() || '';
            
            console.log('Name:', name, 'Email:', email);
            
            const validationMsg = document.getElementById('validation-message');
            
            if (!name || !email) {
                validationMsg.style.display = 'block';
                validationMsg.textContent = 'Please fill in your Name and Email address';
                document.getElementById('step-details').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            // Basic email validation
            if (!email.includes('@') || !email.includes('.')) {
                validationMsg.style.display = 'block';
                validationMsg.textContent = 'Please enter a valid email address';
                return;
            }
            
            validationMsg.style.display = 'none';
            
            // Gather all data
            const services = [];
            document.querySelectorAll('.stage-checkbox:checked').forEach(checkbox => {
                const stage = checkbox.closest('.journey-stage');
                services.push(stage.dataset.title);
            });
            
            const wallTypes = [];
            document.querySelectorAll('.wall-type-option input:checked').forEach(input => {
                wallTypes.push(input.value);
            });
            
            // Get geotechnical report status
            const geotechRadio = document.querySelector('input[name="geotech-status"]:checked');
            let geotechStatus = 'Not specified';
            if (geotechRadio) {
                const geotechValues = {
                    'have-report': 'Yes, I have a geotechnical report',
                    'need-report': 'No, please include geotechnical investigation in the quote',
                    'not-sure': 'Not sure - please advise'
                };
                geotechStatus = geotechValues[geotechRadio.value] || geotechRadio.value;
            }
            
            const quoteData = {
                timestamp: new Date().toISOString(),
                client: {
                    name: name,
                    email: email,
                    phone: document.getElementById('client-phone')?.value || '',
                    company: document.getElementById('client-company')?.value || ''
                },
                services: services,
                location: {
                    address: selectedAddress,
                    coordinates: selectedCoordinates
                },
                walls: drawnWalls.map(w => ({
                    id: w.id,
                    length: w.distance,
                    lengthFormatted: formatDistance(w.distance),
                    height: w.height || null,
                    heightFormatted: w.height ? `${w.height}m` : 'Not specified',
                    coordinates: w.latlngs
                })),
                numberOfWalls: drawnWalls.length,
                totalWallLength: drawnWalls.reduce((sum, w) => sum + w.distance, 0),
                totalWallLengthFormatted: formatDistance(drawnWalls.reduce((sum, w) => sum + w.distance, 0)),
                wallTypes: wallTypes,
                otherWallType: document.getElementById('other-wall-type')?.value || '',
                geotech: geotechStatus,
                notes: document.getElementById('client-notes')?.value || '',
                attachments: uploadedFiles.map(f => ({ name: f.name, type: f.type, size: f.size })),
                mapSnapshot: mapSnapshot
            };
            
            console.log('Quote data prepared:', quoteData);
            
            // Store in sessionStorage
            sessionStorage.setItem('quoteRequestData', JSON.stringify(quoteData));
            sessionStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
            
            // Create email content
            const emailBody = generateEmailBody(quoteData);
            
            console.log('Opening submission modal...');
            
            // Show success modal and options
            showSubmissionModal(quoteData, emailBody);
        }
        
        function generateEmailBody(data) {
            let body = `NEW QUOTE REQUEST FROM REWALL WEBSITE\n`;
            body += `${'='.repeat(50)}\n\n`;
            
            body += `CLIENT DETAILS:\n`;
            body += `Name: ${data.client.name}\n`;
            body += `Email: ${data.client.email}\n`;
            body += `Phone: ${data.client.phone || 'Not provided'}\n`;
            body += `Company: ${data.client.company || 'Not provided'}\n\n`;
            
            body += `SERVICES REQUESTED:\n`;
            if (data.services.length > 0) {
                data.services.forEach(s => body += `‚Ä¢ ${s}\n`);
            } else {
                body += `No specific services selected\n`;
            }
            body += `\n`;
            
            body += `SITE LOCATION:\n`;
            body += `${data.location.address || 'Not specified'}\n`;
            if (data.location.coordinates) {
                body += `Coordinates: ${data.location.coordinates.lat.toFixed(6)}, ${data.location.coordinates.lon.toFixed(6)}\n`;
            }
            body += `\n`;
            
            body += `WALL MEASUREMENTS (ESTIMATED)*:\n`;
            if (data.walls.length > 0) {
                data.walls.forEach(w => {
                    const heightInfo = w.height ? ` x ${w.heightFormatted} high` : ' (height not specified)';
                    body += `‚Ä¢ Wall #${w.id}: ~${w.lengthFormatted} length${heightInfo}\n`;
                });
                body += `EST. TOTAL LENGTH: ~${data.totalWallLengthFormatted}\n`;
                body += `*Note: These are approximate measurements based on map drawings and should not be relied upon for final calculations.\n`;
            } else {
                body += `No walls drawn on map\n`;
            }
            body += `\n`;
            
            body += `WALL TYPES:\n`;
            if (data.wallTypes.length > 0) {
                data.wallTypes.forEach(t => body += `‚Ä¢ ${t}\n`);
            } else {
                body += `Not specified\n`;
            }
            if (data.otherWallType) {
                body += `Other details: ${data.otherWallType}\n`;
            }
            body += `\n`;
            
            body += `PROJECT NOTES:\n`;
            body += `${data.notes || 'No notes provided'}\n\n`;
            
            body += `ATTACHMENTS:\n`;
            if (data.attachments.length > 0) {
                data.attachments.forEach(a => body += `‚Ä¢ ${a.name} (${(a.size/1024).toFixed(1)} KB)\n`);
            } else {
                body += `No files attached\n`;
            }
            body += `\n`;
            
            body += `${'='.repeat(50)}\n`;
            body += `Submitted: ${new Date().toLocaleString('en-NZ')}\n`;
            
            return body;
        }
        
        function showSubmissionModal(data, emailBody) {
            // Store data for direct send
            window.currentQuoteData = data;
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'submission-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, var(--teal-accent) 0%, #3a8a9a 100%); padding: 30px; border-radius: 16px 16px 0 0; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 10px;">üéâ</div>
                            <h2 style="color: white; margin: 0;">Quote Request Ready!</h2>
                            <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0;">Thank you, ${data.client.name}</p>
                        </div>
                        
                        <div style="padding: 30px;">
                            <p style="color: var(--slate); margin-bottom: 20px;">Your quote request is ready with ${data.mapSnapshot ? 'map snapshot' : ''}${data.mapSnapshot && uploadedFiles.length > 0 ? ' + ' : ''}${uploadedFiles.length > 0 ? uploadedFiles.length + ' file(s)' : ''}.</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <button id="direct-send-btn" onclick="sendWithAttachments()" style="padding: 16px 24px; background: linear-gradient(135deg, #28a745 0%, #20863a 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(40,167,69,0.3);">
                                    üöÄ Send Quote Request Now
                                </button>
                                <p style="text-align: center; font-size: 0.85rem; color: var(--slate); margin: 0;">Sends directly to ReWall with all attachments</p>
                                
                                <div style="border-top: 1px solid var(--border-gray); margin: 10px 0; padding-top: 15px;">
                                    <p style="font-size: 0.9rem; color: var(--slate); margin-bottom: 10px;">Other options:</p>
                                    
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="copyToClipboard()" style="flex: 1; padding: 10px 16px; background: var(--light-gray); color: var(--primary-black); border: 1px solid var(--border-gray); border-radius: 8px; font-size: 0.9rem; cursor: pointer;">
                                            üìã Copy
                                        </button>
                                        
                                        <button onclick="downloadAll()" style="flex: 1; padding: 10px 16px; background: var(--light-gray); color: var(--primary-black); border: 1px solid var(--border-gray); border-radius: 8px; font-size: 0.9rem; cursor: pointer;">
                                            üíæ Download All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: var(--soft-blue); border-radius: 8px;">
                                <p style="margin: 0; font-size: 0.9rem; color: var(--slate);">
                                    <strong>üìû Prefer to call?</strong><br>
                                    Ring us at <a href="tel:+64273941127" style="color: var(--teal-accent); font-weight: 600;">027 394 1127</a> and mention your quote reference.
                                </p>
                            </div>
                            
                            <button onclick="closeSubmissionModal()" style="margin-top: 20px; padding: 12px 24px; background: var(--light-gray); color: var(--primary-black); border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; width: 100%;">
                                ‚Üê Back to Quote Builder
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store email body for later use
            window.currentEmailBody = emailBody;
        }
        
        function closeSubmissionModal() {
            const modal = document.getElementById('submission-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Convert base64 data URL to Blob
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
        
        // Main send function using FormSubmit.co with hidden form for reliable attachment support
        async function sendWithAttachments() {
            const btn = document.getElementById('direct-send-btn');
            const data = window.currentQuoteData;
            
            btn.innerHTML = '‚è≥ Preparing submission...';
            btn.disabled = true;
            
            try {
                // Create a hidden form for submission (more reliable for attachments)
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://formsubmit.co/Rewallsolutions@gmail.com';
                form.enctype = 'multipart/form-data';
                form.style.display = 'none';
                
                // Helper to add hidden field
                const addField = (name, value) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                };
                
                // FormSubmit configuration
                addField('_subject', 'ReWall Quote Request - ' + (data.location.address || 'New Project'));
                addField('_captcha', 'false');
                addField('_template', 'table');
                addField('_cc', data.client.email);
                addField('_next', window.location.href.split('?')[0] + '?submitted=true');
                
                // Client details
                addField('Client Name', data.client.name);
                addField('Client Email', data.client.email);
                addField('Client Phone', data.client.phone || 'Not provided');
                addField('Company/Project', data.client.company || 'Not specified');
                
                // Location
                addField('Site Address', data.location.address || 'Not specified');
                if (data.location.coordinates) {
                    addField('Coordinates', `${data.location.coordinates.lat}, ${data.location.coordinates.lon || data.location.coordinates.lng}`);
                }
                
                // Services
                addField('Selected Services', data.services.join(', ') || 'None selected');
                
                // Wall details
                addField('Number of Walls', data.numberOfWalls || 0);
                if (data.walls && data.walls.length > 0) {
                    let wallDetails = data.walls.map((w) => 
                        `Wall ${w.id}: ${w.lengthFormatted} long` + (w.height ? `, ${w.height}m high` : '')
                    ).join(' | ');
                    addField('Wall Measurements', wallDetails);
                    addField('Total Wall Length', data.totalWallLengthFormatted || 'Not measured');
                } else {
                    addField('Wall Measurements', 'No walls drawn on map');
                    addField('Total Wall Length', 'N/A');
                }
                
                // Wall types
                addField('Wall Types', data.wallTypes.join(', ') || 'Not specified');
                if (data.otherWallType) {
                    addField('Other Wall Type Details', data.otherWallType);
                }
                
                // Geotechnical
                addField('Geotechnical Report', data.geotech || 'Not specified');
                
                // Notes
                addField('Project Notes', data.notes || 'None');
                
                // Add map snapshot as base64 attachment (FormSubmit accepts this format)
                let attachmentCount = 0;
                if (data.mapSnapshot) {
                    btn.innerHTML = '‚è≥ Preparing map image...';
                    // Add as hidden field with special naming for FormSubmit attachment
                    addField('_attachment[ReWall-Site-Map.png]', data.mapSnapshot);
                    attachmentCount++;
                    console.log('Map snapshot added to form');
                }
                
                // Add uploaded files - need to convert to base64 for FormSubmit
                if (uploadedFiles && uploadedFiles.length > 0) {
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        btn.innerHTML = `‚è≥ Preparing file ${i + 1}/${uploadedFiles.length}...`;
                        if (uploadedFiles[i].file) {
                            // Read file as base64
                            const reader = new FileReader();
                            await new Promise((resolve) => {
                                reader.onload = function(e) {
                                    const base64Data = e.target.result;
                                    addField(`_attachment[${uploadedFiles[i].name}]`, base64Data);
                                    attachmentCount++;
                                    console.log(`File ${uploadedFiles[i].name} added to form`);
                                    resolve();
                                };
                                reader.readAsDataURL(uploadedFiles[i].file);
                            });
                        }
                    }
                }
                
                console.log(`Total attachments: ${attachmentCount}`);
                
                btn.innerHTML = '‚è≥ Sending to ReWall...';
                
                // Append form to body and submit
                document.body.appendChild(form);
                
                // Show submitting message
                const modalContent = document.querySelector('#submission-modal > div > div');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, var(--teal-accent) 0%, #3a8a9a 100%); padding: 30px; border-radius: 16px 16px 0 0; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 10px;">üì§</div>
                            <h2 style="color: white; margin: 0;">Sending...</h2>
                        </div>
                        <div style="padding: 30px; text-align: center;">
                            <p style="font-size: 1.1rem; color: var(--primary-black); margin-bottom: 15px;">
                                <strong>Submitting your quote request with ${attachmentCount} attachment(s)...</strong>
                            </p>
                            <div style="display: flex; justify-content: center; margin: 20px 0;">
                                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--teal-accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            </div>
                            <p style="color: var(--slate);">Please wait, do not close this page...</p>
                            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
                        </div>
                    `;
                }
                
                // Submit the form
                form.submit();
                
            } catch (error) {
                console.error('Submission Error:', error);
                btn.innerHTML = '‚ùå Error';
                btn.style.background = '#dc3545';
                
                setTimeout(() => {
                    alert('There was an error preparing your submission. Please try the "Download All" option instead.');
                    btn.innerHTML = 'üöÄ Send Quote Request Now';
                    btn.style.background = '';
                    btn.disabled = false;
                }, 500);
            }
        }
        
        // Fallback: Open email client with details
        function sendViaEmail() {
            const data = window.currentQuoteData;
            const subject = encodeURIComponent('ReWall Quote Request - ' + (data.location.address || 'New Project'));
            const body = encodeURIComponent(window.currentEmailBody);
            window.location.href = `mailto:Rewallsolutions@gmail.com?subject=${subject}&body=${body}`;
            
            // Download files for manual attachment
            setTimeout(() => {
                if (confirm('Your email app should be open.\n\nWould you like to download the map snapshot and files to attach manually?')) {
                    downloadAll();
                }
            }, 1000);
        }
        
        // Download all files at once
        function downloadAll() {
            const data = window.currentQuoteData;
            
            // Download summary text
            const summaryBlob = new Blob([window.currentEmailBody], { type: 'text/plain' });
            const summaryUrl = URL.createObjectURL(summaryBlob);
            const summaryLink = document.createElement('a');
            summaryLink.href = summaryUrl;
            summaryLink.download = 'ReWall-Quote-Summary.txt';
            document.body.appendChild(summaryLink);
            summaryLink.click();
            document.body.removeChild(summaryLink);
            
            // Download map
            if (data.mapSnapshot) {
                setTimeout(() => {
                    const mapLink = document.createElement('a');
                    mapLink.href = data.mapSnapshot;
                    mapLink.download = 'ReWall-Site-Map.png';
                    document.body.appendChild(mapLink);
                    mapLink.click();
                    document.body.removeChild(mapLink);
                }, 300);
            }
            
            // Download other files - create download links from File objects
            if (uploadedFiles && uploadedFiles.length > 0) {
                uploadedFiles.forEach((fileObj, idx) => {
                    setTimeout(() => {
                        if (fileObj.file) {
                            const url = URL.createObjectURL(fileObj.file);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileObj.name;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }
                    }, 600 + (idx * 300));
                });
            }
            
            alert('‚úì Files downloading!\n\nEmail these to: Rewallsolutions@gmail.com');
        }
        
        function copyToClipboard() {
            navigator.clipboard.writeText(window.currentEmailBody).then(() => {
                alert('‚úì Summary copied to clipboard!\n\nYou can now paste it into an email.');
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = window.currentEmailBody;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úì Summary copied to clipboard!');
            });
        }
    </script>
</body>
</html>
