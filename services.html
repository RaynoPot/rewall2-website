<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ReWall NZ Services - Full-service retaining wall solutions, engineering design, council submissions, and construction oversight.">
    <meta name="keywords" content="retaining wall services, engineering design, council submissions, construction">
    
    <meta property="og:title" content="Services - ReWall NZ">
    <meta property="og:description" content="Complete retaining wall solutions and flexible Mix & Match services">
    
    <title>Services - ReWall NZ</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <style>
        /* Quote Builder Styles */
        .quote-builder {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: var(--spacing-xxl) 0;
            border-top: 3px solid var(--teal-accent);
        }
        
        .quote-step {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 4px solid var(--teal-accent);
        }
        
        .quote-step-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: var(--teal-accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .step-number.completed {
            background: #28a745;
        }
        
        .quote-step h3 {
            margin: 0;
            color: var(--primary-black);
        }
        
        .quote-step-description {
            color: var(--slate);
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }
        
        /* Map Container */
        #map-container {
            height: 500px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-gray);
            margin-bottom: var(--spacing-md);
        }
        
        #site-map {
            height: 100%;
            width: 100%;
        }
        
        .map-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Enhanced Address Search with Autocomplete */
        .address-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .address-search-wrapper {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .address-search input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .address-search input:focus {
            border-color: var(--teal-accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 164, 0.2);
        }
        
        .address-search button {
            padding: 12px 24px;
            background: var(--teal-accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .address-search button:hover {
            background: #3a8a9a;
        }
        
        .address-search button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Autocomplete Dropdown */
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--teal-accent);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .address-suggestions.active {
            display: block;
        }
        
        .address-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-gray);
            transition: all 0.2s ease;
        }
        
        .address-suggestion:last-child {
            border-bottom: none;
        }
        
        .address-suggestion:hover {
            background: var(--soft-blue);
        }
        
        .address-suggestion .suggestion-main {
            font-weight: 600;
            color: var(--primary-black);
        }
        
        .address-suggestion .suggestion-secondary {
            font-size: 0.85rem;
            color: var(--slate);
            margin-top: 2px;
        }
        
        .address-searching {
            padding: 16px;
            text-align: center;
            color: var(--slate);
        }
        
        .address-searching::before {
            content: "üîç ";
        }
        
        .map-layer-toggle {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--light-gray);
            padding: 4px;
            border-radius: var(--radius-md);
        }
        
        .map-layer-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .map-layer-toggle button.active {
            background: var(--teal-accent);
            color: white;
        }
        
        /* Layer toggles */
        .layer-toggles {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .layer-toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
        }
        
        .layer-toggle-item:hover {
            background: var(--soft-blue);
        }
        
        .layer-toggle-item.active {
            background: var(--teal-accent);
            color: white;
        }
        
        .layer-toggle-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--teal-accent);
        }
        
        .drawing-info {
            background: #e3f2fd;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            border-left: 4px solid #2196f3;
        }
        
        .drawing-info h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: #1976d2;
        }
        
        .drawing-info p {
            margin: 0;
            color: var(--slate);
            font-size: 0.95rem;
        }
        
        .drawn-walls-list {
            margin-top: var(--spacing-md);
            background: var(--light-gray);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }
        
        .drawn-walls-list h4 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--primary-black);
        }
        
        .wall-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .wall-item:last-child {
            margin-bottom: 0;
        }
        
        .wall-item .wall-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .wall-item .wall-length {
            font-weight: 600;
            color: var(--teal-accent);
        }
        
        .wall-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .total-length {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--teal-accent);
            color: white;
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Wall Type Selection */
        .wall-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .wall-type-option {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--light-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .wall-type-option:hover {
            border-color: var(--teal-accent);
            background: white;
        }
        
        .wall-type-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: var(--spacing-sm);
            accent-color: var(--teal-accent);
        }
        
        .wall-type-option.selected {
            border-color: var(--teal-accent);
            background: #e8f4f5;
        }
        
        .wall-type-option label {
            cursor: pointer;
            font-weight: 500;
        }
        
        .other-input {
            margin-top: var(--spacing-sm);
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-sm);
            display: none;
        }
        
        .other-input.visible {
            display: block;
        }
        
        /* Quote Summary */
        .quote-summary {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-xl);
        }
        
        .quote-summary h3 {
            color: var(--teal-accent);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }
        
        .summary-section {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-section:last-of-type {
            border-bottom: none;
        }
        
        .summary-section h4 {
            color: var(--baby-blue);
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-section p, .summary-section ul {
            margin: 0;
            color: rgba(255,255,255,0.9);
        }
        
        .summary-section ul {
            list-style: none;
            padding: 0;
        }
        
        .summary-section li {
            padding: 4px 0;
        }
        
        .submit-quote-btn {
            width: 100%;
            padding: 16px 32px;
            background: var(--teal-accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .submit-quote-btn:hover {
            background: #3a8a9a;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 144, 164, 0.4);
        }
        
        .submit-quote-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .optional-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: var(--spacing-sm);
        }
        
        /* Live distance tooltip */
        .distance-tooltip {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        /* Service Tags */
        .service-tag {
            display: inline-block;
            background: var(--teal-accent);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Search Marker */
        .search-marker {
            font-size: 24px;
            text-align: center;
        }
        
        /* Leaflet custom styling */
        .leaflet-draw-toolbar a {
            background-color: var(--teal-accent) !important;
        }
        
        .leaflet-draw-actions a {
            background-color: #333 !important;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Map snapshot preview */
        #map-snapshot-preview {
            margin-top: var(--spacing-md);
            display: none;
        }
        
        #map-snapshot-preview img {
            max-width: 100%;
            border-radius: var(--radius-md);
            border: 2px solid var(--teal-accent);
        }
        
        #map-snapshot-preview .snapshot-label {
            font-size: 0.85rem;
            color: var(--slate);
            margin-top: var(--spacing-sm);
        }
        
        /* Responsive summary grid */
        @media (max-width: 768px) {
            .quote-summary > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <svg viewBox="0 0 150 50" xmlns="http://www.w3.org/2000/svg">
                <text x="5" y="40" font-family="Arial, sans-serif" font-size="40" font-weight="bold" fill="#FFFFFF" stroke="#4A90A4" stroke-width="2">R:Wall</text>
            </svg>
        </div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="#services" class="active">Services</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="blog.html">Blog</a></li>
        </ul>
        
        <div class="divider"></div>
        
        <div class="cta-group">
            <button class="btn" onclick="window.location.href='contact.html'">Request a Quote</button>
            <button class="btn secondary" onclick="window.location.href='https://databloc.nz'">Plan Your Wall</button>
        </div>
        
        <div class="divider"></div>
        
        <ul>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>

    <button class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <main>
        <!-- Hero Section -->
        <section class="hero" id="services">
            <div class="content">
                <h1>Your Complete Journey</h1>
                <p class="subheadline"><strong>Pick One. Pick Many. Pick All.</strong> You're in control.</p>
                <p style="max-width: 700px; margin: 0 auto; color: var(--slate); font-size: 1rem;">From initial site planning to final sign-off, ReWall guides you through every step. Choose individual services or let us handle the complete journey.</p>
            </div>
        </section>

        <!-- Service Circle Diagram - MAIN FOCUS -->
        <section class="container" style="padding-top: var(--spacing-xl); padding-bottom: var(--spacing-xl);">
            <h2 style="text-align: center; margin-bottom: var(--spacing-md);">Complete the Circle</h2>
            <p style="text-align: center; color: var(--slate); margin-bottom: var(--spacing-lg);">Choose your path: Full service or Mix & Match</p>
            
            <!-- Service Options -->
            <div style="display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap; margin-bottom: var(--spacing-lg);">
                <button class="service-option-btn active" onclick="selectServiceMode('all')" data-mode="all">
                    ‚úì Complete Package
                </button>
                <button class="service-option-btn" onclick="selectServiceMode('custom')" data-mode="custom">
                    ‚úì Mix & Match
                </button>
            </div>
            
            <p style="text-align: center; max-width: 700px; margin: 0 auto var(--spacing-xl); font-size: 0.95rem; color: var(--slate); line-height: 1.6;">
                <strong>Complete Package:</strong> All 6 stages‚Äîlet us handle everything from planning to sign-off.
                <br><br>
                <strong>Mix & Match:</strong> Pick one stage, pick multiple stages, or pick all. Click the stages below to build the exact package you need. Perfect for any timeline and budget.
            </p>
            
            <div class="journey-circle-container">
                <!-- Center info box -->
                <div class="journey-center">
                    <div id="service-mode-display" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 8px;">‚úì Complete Journey</div>
                    <h3 id="stage-title">Complete the Circle</h3>
                    <p id="stage-description" style="font-size: 0.8rem;">Hover over any stage to learn more, or switch to Mix & Match mode to select specific stages</p>
                </div>
                
                <!-- Stage 1: Planning -->
                <div class="journey-stage" data-stage="1" data-title="Site Planning" data-description="We assess your site, measure dimensions, evaluate soil conditions, and identify opportunities. Our team creates an initial scope of work and timeline.">
                    <input type="checkbox" class="stage-checkbox" id="stage-1" data-stage="1">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-planning.svg" alt="Site Planning" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Site Planning</div>
                </div>
                
                <!-- Stage 2: Design -->
                <div class="journey-stage" data-stage="2" data-title="Engineering Design" data-description="Our Nemean-backed engineers create detailed designs, perform structural calculations, and produce technical drawings. All designs meet local building codes.">
                    <input type="checkbox" class="stage-checkbox" id="stage-2" data-stage="2">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-design.svg" alt="Engineering Design" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Design</div>
                </div>
                
                <!-- Stage 3: Estimate -->
                <div class="journey-stage" data-stage="3" data-title="Cost Estimate" data-description="Based on the design, we provide a detailed cost estimate including materials, labor, and timeline. We explain every line item so you know what you're paying for.">
                    <input type="checkbox" class="stage-checkbox" id="stage-3" data-stage="3">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-estimate.svg" alt="Cost Estimate" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Estimate</div>
                </div>
                
                <!-- Stage 4: Consent -->
                <div class="journey-stage" data-stage="4" data-title="Council Consent" data-description="Not sure if you need consent? Share your address and wall dimensions‚Äîwe'll check requirements for your area. We handle all submissions, resource consents, and building permits.">
                    <input type="checkbox" class="stage-checkbox" id="stage-4" data-stage="4">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-consent.svg" alt="Council Consent" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Consent</div>
                </div>
                
                <!-- Stage 5: Construction -->
                <div class="journey-stage" data-stage="5" data-title="Construction" data-description="Our trusted construction partners execute the project with quality and safety. We provide oversight, inspections, and regular progress updates throughout.">
                    <input type="checkbox" class="stage-checkbox" id="stage-5" data-stage="5">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-construction.svg" alt="Construction" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Construction</div>
                </div>
                
                <!-- Stage 6: Sign-Off -->
                <div class="journey-stage" data-stage="6" data-title="Final Sign-Off" data-description="Once complete, we conduct final inspections, obtain sign-offs from authorities, and hand over the project to you with all documentation and warranties.">
                    <input type="checkbox" class="stage-checkbox" id="stage-6" data-stage="6">
                    <div class="journey-stage-icon">
                        <img src="images/icons/stage-signoff.svg" alt="Final Sign-Off" loading="lazy">
                    </div>
                    <div class="journey-stage-label">Sign-Off</div>
                </div>
            </div>
            
            <!-- Request a Quote Button -->
            <div style="text-align: center; margin-top: var(--spacing-xl);">
                <button id="continue-to-details-btn" class="btn" onclick="scrollToQuoteBuilder()">
                    Continue to Quote Builder ‚Üí
                </button>
            </div>
        </section>

        <!-- Quote Builder Section -->
        <section class="quote-builder" id="quote-builder">
            <div class="container">
                <div style="text-align: center; margin-bottom: var(--spacing-xxl);">
                    <h2>Build Your Quote</h2>
                    <p style="max-width: 700px; margin: 0 auto; color: var(--slate); font-size: 1.1rem;">
                        You're almost there! Complete the steps below to get an accurate quote. 
                        The more details you provide, the more precise your estimate will be.
                    </p>
                </div>

                <!-- Step 1: Services Selected (Summary from Circle) -->
                <div class="quote-step" id="step-services">
                    <div class="quote-step-header">
                        <div class="step-number" id="step1-number">1</div>
                        <h3>Services Selected</h3>
                    </div>
                    <p class="quote-step-description">
                        Your selected services from the journey circle above. 
                        <a href="#services" style="color: var(--teal-accent);">Go back to modify ‚Üë</a>
                    </p>
                    <div id="selected-services-summary" style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                        <span style="color: var(--slate); font-style: italic;">No services selected yet. Please select from the circle above.</span>
                    </div>
                </div>

                <!-- Step 2: Site Location & Wall Drawing -->
                <div class="quote-step" id="step-map">
                    <div class="quote-step-header">
                        <div class="step-number">2</div>
                        <h3>Mark Your Retaining Wall Location</h3>
                        <span class="optional-badge">Optional but Recommended</span>
                    </div>
                    <p class="quote-step-description">
                        üó∫Ô∏è <strong>Find your property and draw where you need retaining walls.</strong><br>
                        Search for your address, toggle property boundaries on, then use the drawing tool to mark wall locations. 
                        This helps us understand your site and provide a more accurate quote. You can draw multiple walls if needed.
                    </p>
                    
                    <div class="map-controls">
                        <div class="address-search">
                            <div class="address-search-wrapper">
                                <input type="text" id="address-input" placeholder="Start typing your NZ address..." autocomplete="off">
                                <button id="search-btn" onclick="selectFirstSuggestion()">üîç Search</button>
                            </div>
                            <div id="address-suggestions" class="address-suggestions"></div>
                        </div>
                        <div class="map-layer-toggle">
                            <button id="map-btn" class="active" onclick="setMapLayer('map')">Map</button>
                            <button id="satellite-btn" onclick="setMapLayer('satellite')">Satellite</button>
                        </div>
                    </div>
                    
                    <div class="layer-toggles" style="margin-bottom: var(--spacing-md);">
                        <label class="layer-toggle-item" id="boundaries-label">
                            <input type="checkbox" id="boundaries-toggle" onchange="toggleBoundaries()">
                            <span>üè† Property Boundaries</span>
                        </label>
                        <label class="layer-toggle-item" id="contours-label">
                            <input type="checkbox" id="contours-toggle" onchange="toggleContours()">
                            <span>üìà Contours</span>
                        </label>
                    </div>
                    
                    <div id="map-container">
                        <div id="site-map"></div>
                    </div>
                    
                    <div class="drawing-info">
                        <h4>üìè How to Draw Your Walls</h4>
                        <p>
                            <strong>1.</strong> Click the polyline tool (üìê) on the left side of the map<br>
                            <strong>2.</strong> Click on the map to place points along your wall line<br>
                            <strong>3.</strong> Double-click or click "Finish" to complete the wall<br>
                            <strong>4.</strong> The distance will be calculated automatically<br>
                            <strong>5.</strong> Draw additional walls if needed - each will be tracked separately
                        </p>
                    </div>
                    
                    <div id="drawn-walls-container" class="drawn-walls-list" style="display: none;">
                        <h4>üß± Your Marked Walls</h4>
                        <div id="walls-list"></div>
                        <div id="total-length-display" class="total-length"></div>
                    </div>
                </div>

                <!-- Step 3: Wall Type Selection -->
                <div class="quote-step" id="step-wall-type">
                    <div class="quote-step-header">
                        <div class="step-number">3</div>
                        <h3>What Type of Retaining Wall?</h3>
                    </div>
                    <p class="quote-step-description">
                        Select the type(s) of retaining wall you're interested in. Not sure? Select multiple options 
                        and we'll help you choose the best solution for your site. Each type has different cost, 
                        aesthetic, and structural characteristics.
                    </p>
                    
                    <div class="wall-type-grid">
                        <div class="wall-type-option" onclick="toggleWallType(this, 'gravity')">
                            <input type="checkbox" id="wall-gravity" name="wall-type" value="Gravity (Concrete)">
                            <label for="wall-gravity">Gravity (Concrete)</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'hybrid')">
                            <input type="checkbox" id="wall-hybrid" name="wall-type" value="Hybrid">
                            <label for="wall-hybrid">Hybrid</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'landscape')">
                            <input type="checkbox" id="wall-landscape" name="wall-type" value="Landscape">
                            <label for="wall-landscape">Landscape</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'mse')">
                            <input type="checkbox" id="wall-mse" name="wall-type" value="MSE (Mechanically Stabilized Earth)">
                            <label for="wall-mse">MSE</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'timber')">
                            <input type="checkbox" id="wall-timber" name="wall-type" value="Timber">
                            <label for="wall-timber">Timber</label>
                        </div>
                        <div class="wall-type-option" onclick="toggleWallType(this, 'other')">
                            <input type="checkbox" id="wall-other" name="wall-type" value="Other">
                            <label for="wall-other">Other</label>
                        </div>
                    </div>
                    <input type="text" id="other-wall-type" class="other-input" placeholder="Please describe the wall type you're looking for...">
                </div>

                <!-- Step 4: Your Details & Notes -->
                <div class="quote-step" id="step-details">
                    <div class="quote-step-header">
                        <div class="step-number">4</div>
                        <h3>Your Details & Project Notes</h3>
                    </div>
                    <p class="quote-step-description">
                        Tell us about yourself and your project. The more information you provide, the more accurate and helpful our response will be.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-md);">
                        <div>
                            <label for="client-name" style="display: block; font-weight: 600; margin-bottom: 8px;">Full Name *</label>
                            <input type="text" id="client-name" placeholder="Your full name" required style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                        <div>
                            <label for="client-email" style="display: block; font-weight: 600; margin-bottom: 8px;">Email Address *</label>
                            <input type="email" id="client-email" placeholder="your@email.com" required style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                        <div>
                            <label for="client-phone" style="display: block; font-weight: 600; margin-bottom: 8px;">Phone Number</label>
                            <input type="tel" id="client-phone" placeholder="021 123 4567" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                        <div>
                            <label for="client-company" style="display: block; font-weight: 600; margin-bottom: 8px;">Company/Project Name</label>
                            <input type="text" id="client-company" placeholder="Optional" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem;">
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-lg);">
                        <label for="client-notes" style="display: block; font-weight: 600; margin-bottom: 8px;">üìù Project Notes & Questions</label>
                        <textarea id="client-notes" rows="5" placeholder="Tell us about your project... &#10;&#10;‚Ä¢ What's the purpose of the wall? &#10;‚Ä¢ Any specific materials you prefer?&#10;‚Ä¢ Timeline requirements?&#10;‚Ä¢ Budget range?&#10;‚Ä¢ Any access challenges to the site?&#10;‚Ä¢ Questions for our team?" style="width: 100%; padding: 12px; border: 2px solid var(--border-gray); border-radius: var(--radius-md); font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="margin-top: var(--spacing-lg);">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">üìé Attach Site Photos or Documents</label>
                        <p style="color: var(--slate); font-size: 0.9rem; margin-bottom: var(--spacing-sm);">Upload photos of your site, existing plans, or any relevant documents (Max 10MB per file, up to 5 files)</p>
                        <div id="file-upload-area" style="border: 2px dashed var(--border-gray); border-radius: var(--radius-md); padding: var(--spacing-xl); text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--light-gray);">
                            <input type="file" id="file-input" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üìÅ</div>
                            <p style="margin: 0; font-weight: 500;">Drop files here or click to browse</p>
                            <p style="margin: var(--spacing-xs) 0 0; font-size: 0.85rem; color: var(--slate);">Images, PDFs, Word documents</p>
                        </div>
                        <div id="file-list" style="margin-top: var(--spacing-md);"></div>
                    </div>
                </div>

                <!-- Quote Summary -->
                <div class="quote-summary" id="quote-summary">
                    <h3>üìã Your Quote Request Summary</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xl);">
                        <div>
                            <div class="summary-section">
                                <h4>Selected Services</h4>
                                <ul id="summary-services">
                                    <li style="color: rgba(255,255,255,0.6); font-style: italic;">None selected</li>
                                </ul>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Site Location</h4>
                                <p id="summary-location">Not specified</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Wall Measurements</h4>
                                <p id="summary-walls">No walls drawn</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Wall Types</h4>
                                <p id="summary-wall-types">None selected</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Contact Details</h4>
                                <p id="summary-contact">Not provided</p>
                            </div>
                            
                            <div class="summary-section">
                                <h4>Attachments</h4>
                                <p id="summary-attachments">No files attached</p>
                            </div>
                        </div>
                        
                        <div>
                            <div class="summary-section">
                                <h4>Site Map Preview</h4>
                                <div id="map-snapshot-container" style="background: rgba(255,255,255,0.1); border-radius: var(--radius-md); padding: var(--spacing-md); min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <p id="snapshot-placeholder" style="color: rgba(255,255,255,0.5); text-align: center;">
                                        Map snapshot will appear here<br>when you mark wall locations
                                    </p>
                                    <img id="map-snapshot-img" style="max-width: 100%; border-radius: var(--radius-sm); display: none;">
                                </div>
                                <button id="capture-map-btn" onclick="captureMapSnapshot()" style="margin-top: var(--spacing-sm); padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: var(--radius-sm); cursor: pointer; width: 100%; font-size: 0.9rem;">
                                    üì∏ Update Map Snapshot
                                </button>
                            </div>
                            
                            <div class="summary-section" style="border-bottom: none;">
                                <h4>Project Notes</h4>
                                <p id="summary-notes" style="font-style: italic; opacity: 0.7;">No notes added</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid rgba(255,255,255,0.2);">
                        <div id="validation-message" style="display: none; background: #ff5252; color: white; padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md); text-align: center;">
                            Please fill in required fields (Name and Email)
                        </div>
                        
                        <button class="submit-quote-btn" id="submit-quote-btn" onclick="submitQuoteRequest()">
                            üöÄ Submit Quote Request
                        </button>
                        <p style="text-align: center; margin-top: var(--spacing-md); font-size: 0.9rem; opacity: 0.8;">
                            We'll review your request and get back to you within 24-48 hours with a detailed response.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Full-Service Solutions -->
        <section class="alt-bg">
            <div class="container">
                <h2 style="text-align: center;">Full-Service Solutions: Complete the Circle</h2>
                <p style="text-align: center; max-width: 700px; margin: 0 auto var(--spacing-xl);">Let us handle everything from initial consultation to final project sign-off. Choose all 6 stages or select the ones you need.</p>
                
                <div class="grid" style="grid-template-columns: repeat(2, 1fr); margin-top: var(--spacing-xl);">
                    <div class="card">
                        <h3>üìã Project Management</h3>
                        <p>We coordinate every aspect of your retaining wall project:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Initial site assessment</li>
                            <li>‚úì Scope definition & budgeting</li>
                            <li>‚úì Timeline planning</li>
                            <li>‚úì Stakeholder communication</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>üìê Engineering Design</h3>
                        <p>Expert structural and geotechnical engineering:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Wall type selection</li>
                            <li>‚úì Detailed design drawings</li>
                            <li>‚úì Soil analysis & calculations</li>
                            <li>‚úì Safety certifications</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>ÔøΩ Cost Estimation</h3>
                        <p>Transparent pricing based on your project scope:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Detailed cost breakdown</li>
                            <li>‚úì Materials & labor quotes</li>
                            <li>‚úì Timeline & budget planning</li>
                            <li>‚úì No hidden costs</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>üìú Council Consent</h3>
                        <p>Seamless consent and compliance process:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Resource consent preparation</li>
                            <li>‚úì Building consent documentation</li>
                            <li>‚úì Authority liaison & follow-up</li>
                            <li>‚úì Permit coordination</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>üèóÔ∏è Construction</h3>
                        <p>Quality construction execution with professional oversight:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Expert construction partners</li>
                            <li>‚úì Quality assurance inspections</li>
                            <li>‚úì Safety compliance</li>
                            <li>‚úì Regular progress updates</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3>‚úì Final Sign-Off</h3>
                        <p>Complete project handover with full documentation:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úì Final inspections & testing</li>
                            <li>‚úì Authority sign-offs obtained</li>
                            <li>‚úì Complete documentation package</li>
                            <li>‚úì Warranty & maintenance guide</li>
                        </ul>
                    </div>
                </div>

                <div style="text-align: center; margin-top: var(--spacing-xl);">
                    <button class="btn" onclick="window.location.href='contact.html'">Request Full-Service Quote</button>
                </div>
            </div>
        </section>

        <!-- Retaining Wall Types -->
        <section class="container">
            <h2 style="text-align: center; margin-bottom: var(--spacing-xl);">Wall Types We Specialize In</h2>
            
            <div class="grid grid-2">
                <div class="card">
                    <h3>MSE/MSC Walls</h3>
                    <p><strong>Mechanically Stabilized Earth Walls</strong></p>
                    <p>High-performance solutions for large spans and heavy loads. Ideal for commercial and industrial applications.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Cost-effective for high walls</li>
                        <li>‚Ä¢ Excellent load-bearing capacity</li>
                        <li>‚Ä¢ Flexible design options</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Gravity Retaining Walls</h3>
                    <p><strong>Classic Concrete & Masonry</strong></p>
                    <p>Solid, reliable structures using the weight of the wall itself. Perfect for residential and smaller projects.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Simple, proven design</li>
                        <li>‚Ä¢ Minimal maintenance</li>
                        <li>‚Ä¢ Custom finishes available</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Timber Retaining Walls</h3>
                    <p><strong>Natural & Aesthetic</strong></p>
                    <p>Environmentally-friendly timber solutions that blend seamlessly with landscaping. Ideal for gardens and residential areas.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Natural appearance</li>
                        <li>‚Ä¢ Sustainable materials</li>
                        <li>‚Ä¢ Lower height restrictions</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Concrete Retaining Walls</h3>
                    <p><strong>Durable & Long-lasting</strong></p>
                    <p>Precast and cast-in-place concrete options for maximum durability and architectural flexibility.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Superior longevity</li>
                        <li>‚Ä¢ Design flexibility</li>
                        <li>‚Ä¢ Weather resistant</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Landscape/Garden Walls</h3>
                    <p><strong>Aesthetic Soil Retention</strong></p>
                    <p>Decorative solutions for smaller-scale projects that enhance landscape design while retaining soil.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Design-focused</li>
                        <li>‚Ä¢ Varied material options</li>
                        <li>‚Ä¢ Quick installation</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Custom Solutions</h3>
                    <p><strong>Tailored to Your Needs</strong></p>
                    <p>Unique projects require unique solutions. We design custom systems for complex site conditions.</p>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚Ä¢ Site-specific engineering</li>
                        <li>‚Ä¢ Innovative approaches</li>
                        <li>‚Ä¢ Specialized expertise</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Flexible Engagement -->
        <section class="alt-bg">
            <div class="container">
                <h2 style="text-align: center; margin-bottom: var(--spacing-md);">Flexible Engagement: Mix & Match Services</h2>
                <p style="text-align: center; max-width: 700px; margin: 0 auto var(--spacing-xl); color: var(--slate);">Not ready for the complete package? Choose the specific services you need right now. Perfect flexibility for your timeline and budget.</p>
                
                <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-top: var(--spacing-xl); gap: var(--spacing-lg);">
                    <div class="card" style="border-left: 5px solid var(--teal-accent); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--teal-accent);">üéØ Engineering Design Only</h3>
                        <p style="font-size: 0.95rem; color: var(--slate); margin-bottom: var(--spacing-md);"><strong>Perfect for:</strong> Builders with their own project management</p>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li>‚úì Complete structural design</li>
                            <li>‚úì Technical drawings & specs</li>
                            <li>‚úì Engineering certification</li>
                            <li>‚úì Consultation & support</li>
                        </ul>
                    </div>
                    <div class="card" style="border-left: 5px solid var(--teal-accent); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--teal-accent);">üìã Council Submission Support</h3>
                        <p style="font-size: 0.95rem; color: var(--slate); margin-bottom: var(--spacing-md);"><strong>Perfect for:</strong> Designers needing consent expertise</p>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li>‚úì Consent application prep</li>
                            <li>‚úì Authority liaison</li>
                            <li>‚úì Documentation support</li>
                            <li>‚úì Follow-up & amendments</li>
                        </ul>
                    </div>
                    <div class="card" style="border-left: 5px solid var(--teal-accent); border-radius: var(--radius-lg);">
                        <h3 style="color: var(--teal-accent);">üèóÔ∏è Construction Supervision</h3>
                        <p style="font-size: 0.95rem; color: var(--slate); margin-bottom: var(--spacing-md);"><strong>Perfect for:</strong> Those managing their own design phase</p>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li>‚úì Quality inspections</li>
                            <li>‚úì Safety oversight</li>
                            <li>‚úì Progress monitoring</li>
                            <li>‚úì Final certification</li>
                        </ul>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: var(--spacing-xl);">
                    <button class="btn" onclick="window.location.href='contact.html'">Get a Custom Quote</button>
                </div>
            </div>
        </section>

        <!-- Service Selection Popup Modal -->
        <div id="service-popup" class="service-popup">
            <div class="service-popup-content">
                <button class="popup-close" onclick="closeServicePopup()">√ó</button>
                <h3>Ready to Get Started?</h3>
                <p id="popup-selection-summary" style="font-size: 1.1rem; margin: var(--spacing-md) 0; color: var(--slate);"></p>
                <p style="color: var(--slate); margin-bottom: var(--spacing-lg);">
                    Complete the next step by requesting a quote from our team. We'll review your selections and provide a detailed proposal.
                </p>
                <div style="display: flex; gap: var(--spacing-md); justify-content: center;">
                    <button class="btn" onclick="window.location.href='contact.html'">Request a Quote</button>
                    <button class="btn secondary" onclick="closeServicePopup()">Continue Browsing</button>
                </div>
            </div>
        </div>

        <!-- Future Tools -->
        <section class="container">
            <div class="card" style="background: linear-gradient(135deg, var(--soft-blue) 0%, #dbe8f0 100%); border-left: 4px solid var(--teal-accent);">
                <h3 style="color: var(--teal-accent);">üîÆ Coming Soon: DIY Planning Tool</h3>
                <p><strong>Transform the way you plan retaining walls</strong></p>
                <p>Our next-generation digital tool (powered by Data Bloc) will enable you to:</p>
                <ul style="list-style: none; padding: 0; columns: 2;">
                    <li>‚úì Visualize your wall in 3D</li>
                    <li>‚úì Run automated calculations</li>
                    <li>‚úì Generate preliminary scopes</li>
                    <li>‚úì Export pre-quote data</li>
                </ul>
                <p style="margin-top: var(--spacing-lg);"><em>Want early access? Contact us to join the beta program.</em></p>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-brand">
                        <img src="images/Logos/re wall logo (1).png" alt="ReWall Logo" style="width: 180px; height: auto; margin-bottom: var(--spacing-md);">
                        <p>Premium retaining wall solutions with expert engineering, smart digital tools, and trusted construction partners.</p>
                        <div class="footer-contact-inline">
                            <a href="mailto:info@databloc.nz">üìß info@databloc.nz</a>
                            <a href="tel:+64273941127">üìû 027 394 1127</a>
                        </div>
                    </div>
                    <div class="footer-links-group">
                        <div class="footer-col">
                            <h4>Quick Links</h4>
                            <ul>
                                <li><a href="index.html">Home</a></li>
                                <li><a href="about.html">About</a></li>
                                <li><a href="services.html">Services</a></li>
                                <li><a href="gallery.html">Gallery</a></li>
                                <li><a href="blog.html">Blog</a></li>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <h4>Services</h4>
                            <ul>
                                <li><a href="services.html">Full-Service Solutions</a></li>
                                <li><a href="services.html">Engineering Design</a></li>
                                <li><a href="services.html">Council Submissions</a></li>
                                <li><a href="services.html">Construction</a></li>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <h4>Get In Touch</h4>
                            <ul>
                                <li><a href="contact.html">Contact Form</a></li>
                                <li><a href="contact.html">Request a Quote</a></li>
                                <li><a href="https://databloc.nz" target="_blank">Plan Your Wall</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 ReWall NZ. All rights reserved. | <a href="#privacy">Privacy Policy</a></p>
            </div>
        </footer>
    </main>

    <script src="js/scripts.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- html2canvas for map snapshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Quote Builder JavaScript -->
    <script>
        // ==========================================
        // QUOTE BUILDER - Interactive Map & Tools
        // ==========================================
        
        let map;
        let drawnItems;
        let drawControl;
        let currentLayer = 'map';
        let mapTileLayer;
        let satelliteTileLayer;
        let boundaryLayer;
        let contourLayer;
        let drawnWalls = [];
        let wallCounter = 0;
        let searchMarker;
        let selectedAddress = '';
        let selectedCoordinates = null;
        let mapSnapshot = null;
        let uploadedFiles = [];
        let searchTimeout = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeAddressSearch();
            initializeFileUpload();
            updateQuoteSummary();
        });
        
        // Scroll to quote builder
        function scrollToQuoteBuilder() {
            document.getElementById('quote-builder').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        // ==========================================
        // ADDRESS SEARCH WITH AUTOCOMPLETE
        // ==========================================
        
        function initializeAddressSearch() {
            const input = document.getElementById('address-input');
            const suggestions = document.getElementById('address-suggestions');
            
            // Debounced search as user types
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    suggestions.classList.remove('active');
                    return;
                }
                
                // Show loading state
                suggestions.innerHTML = '<div class="address-searching">Searching...</div>';
                suggestions.classList.add('active');
                
                // Debounce the search
                searchTimeout = setTimeout(() => searchAddresses(query), 300);
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.address-search')) {
                    suggestions.classList.remove('active');
                }
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('.address-suggestion');
                const active = suggestions.querySelector('.address-suggestion.highlighted');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (active) {
                        active.classList.remove('highlighted');
                        const next = active.nextElementSibling;
                        if (next) next.classList.add('highlighted');
                        else items[0]?.classList.add('highlighted');
                    } else {
                        items[0]?.classList.add('highlighted');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (active) {
                        active.classList.remove('highlighted');
                        const prev = active.previousElementSibling;
                        if (prev) prev.classList.add('highlighted');
                        else items[items.length - 1]?.classList.add('highlighted');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (active) {
                        active.click();
                    } else if (items.length > 0) {
                        items[0].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestions.classList.remove('active');
                }
            });
        }
        
        async function searchAddresses(query) {
            const suggestions = document.getElementById('address-suggestions');
            
            try {
                // Use multiple search sources for better NZ coverage
                const searches = [
                    // Nominatim with NZ focus
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=nz&limit=5&addressdetails=1`),
                    // Photon (another geocoding service)
                    fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query + ' New Zealand')}&limit=5`)
                ];
                
                const [nominatimRes, photonRes] = await Promise.allSettled(searches);
                
                let results = [];
                
                // Process Nominatim results
                if (nominatimRes.status === 'fulfilled') {
                    const nominatimData = await nominatimRes.value.json();
                    results = nominatimData.map(r => ({
                        display: r.display_name,
                        main: r.name || r.display_name.split(',')[0],
                        secondary: r.display_name.split(',').slice(1, 3).join(','),
                        lat: parseFloat(r.lat),
                        lon: parseFloat(r.lon),
                        type: r.type,
                        source: 'nominatim'
                    }));
                }
                
                // Process Photon results (add unique ones)
                if (photonRes.status === 'fulfilled' && results.length < 5) {
                    try {
                        const photonData = await photonRes.value.json();
                        if (photonData.features) {
                            photonData.features.forEach(f => {
                                if (results.length < 8 && f.properties.country === 'New Zealand') {
                                    const main = f.properties.name || f.properties.street || '';
                                    const secondary = [f.properties.city, f.properties.state].filter(Boolean).join(', ');
                                    
                                    // Avoid duplicates
                                    if (!results.find(r => r.main === main && r.secondary === secondary)) {
                                        results.push({
                                            display: `${main}, ${secondary}, New Zealand`,
                                            main: main,
                                            secondary: secondary,
                                            lat: f.geometry.coordinates[1],
                                            lon: f.geometry.coordinates[0],
                                            type: f.properties.type,
                                            source: 'photon'
                                        });
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Photon parse error:', e);
                    }
                }
                
                if (results.length === 0) {
                    suggestions.innerHTML = '<div class="address-suggestion"><span class="suggestion-main">No results found</span><span class="suggestion-secondary">Try a different search term</span></div>';
                } else {
                    suggestions.innerHTML = results.map((r, i) => `
                        <div class="address-suggestion" data-lat="${r.lat}" data-lon="${r.lon}" data-display="${r.display}">
                            <div class="suggestion-main">${highlightMatch(r.main, document.getElementById('address-input').value)}</div>
                            <div class="suggestion-secondary">${r.secondary || ''}</div>
                        </div>
                    `).join('');
                    
                    // Add click handlers
                    suggestions.querySelectorAll('.address-suggestion').forEach(el => {
                        el.addEventListener('click', () => selectAddress(el));
                    });
                }
                
                suggestions.classList.add('active');
                
            } catch (error) {
                console.error('Address search error:', error);
                suggestions.innerHTML = '<div class="address-suggestion"><span class="suggestion-main">Search error</span><span class="suggestion-secondary">Please try again</span></div>';
            }
        }
        
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<strong style="color: var(--teal-accent);">$1</strong>');
        }
        
        function selectAddress(element) {
            const lat = parseFloat(element.dataset.lat);
            const lon = parseFloat(element.dataset.lon);
            const display = element.dataset.display;
            
            // Update input
            document.getElementById('address-input').value = display;
            document.getElementById('address-suggestions').classList.remove('active');
            
            // Store address
            selectedAddress = display;
            selectedCoordinates = { lat, lon };
            
            // Remove existing marker
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            // Add new marker with custom icon
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="font-size: 32px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));">üìç</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
            
            searchMarker = L.marker([lat, lon], { icon: markerIcon }).addTo(map);
            searchMarker.bindPopup(`<strong>Your Site</strong><br>${display}`).openPopup();
            
            // Zoom to location
            map.setView([lat, lon], 18);
            
            // Update summary
            updateQuoteSummary();
            
            // Auto-capture map after a short delay
            setTimeout(() => {
                if (drawnWalls.length > 0) {
                    captureMapSnapshot();
                }
            }, 1000);
        }
        
        function selectFirstSuggestion() {
            const firstSuggestion = document.querySelector('.address-suggestion');
            if (firstSuggestion) {
                selectAddress(firstSuggestion);
            } else {
                // If no suggestions, do a search
                const query = document.getElementById('address-input').value.trim();
                if (query.length >= 3) {
                    searchAddresses(query);
                }
            }
        }
        
        // ==========================================
        // LEAFLET MAP INITIALIZATION
        // ==========================================
        
        function initializeMap() {
            // Center on New Zealand
            map = L.map('site-map', {
                center: [-41.2865, 174.7762],
                zoom: 6,
                zoomControl: true
            });
            
            // Map tile layer (OpenStreetMap)
            mapTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 20
            });
            
            // Satellite tile layer (ESRI)
            satelliteTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 20
            });
            
            // LINZ Property boundary layer - using correct WFS endpoint
            boundaryLayer = L.tileLayer('https://basemaps.linz.govt.nz/v1/tiles/aerial/WebMercatorQuad/{z}/{x}/{y}.webp?api=c01j1rxmhp01hdh3v4j6ac5z1dv', {
                attribution: '¬© LINZ CC BY 4.0',
                maxZoom: 20,
                opacity: 0.7
            });
            
            // LINZ Topo layer with contours
            contourLayer = L.tileLayer('https://basemaps.linz.govt.nz/v1/tiles/topographic/WebMercatorQuad/{z}/{x}/{y}.png?api=c01j1rxmhp01hdh3v4j6ac5z1dv', {
                attribution: '¬© LINZ CC BY 4.0',
                maxZoom: 20,
                opacity: 0.8
            });
            
            // Start with map view
            mapTileLayer.addTo(map);
            
            // Initialize drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Add drawing controls
            drawControl = new L.Control.Draw({
                position: 'topleft',
                edit: {
                    featureGroup: drawnItems,
                    remove: true,
                    edit: true
                },
                draw: {
                    polygon: false,
                    rectangle: false,
                    circle: false,
                    circlemarker: false,
                    marker: false,
                    polyline: {
                        shapeOptions: {
                            color: '#e74c3c',
                            weight: 5,
                            opacity: 0.9
                        },
                        metric: true,
                        showLength: true,
                        feet: false
                    }
                }
            });
            map.addControl(drawControl);
            
            // Handle draw events
            map.on('draw:created', handleDrawCreated);
            map.on('draw:deleted', handleDrawDeleted);
            map.on('draw:edited', handleDrawEdited);
        }
        
        // Toggle map layers
        function setMapLayer(type) {
            // Remove both base layers first
            map.removeLayer(mapTileLayer);
            map.removeLayer(satelliteTileLayer);
            
            if (type === 'map') {
                mapTileLayer.addTo(map);
                // Bring to back so overlays show on top
                mapTileLayer.bringToBack();
                document.getElementById('map-btn').classList.add('active');
                document.getElementById('satellite-btn').classList.remove('active');
            } else {
                satelliteTileLayer.addTo(map);
                satelliteTileLayer.bringToBack();
                document.getElementById('satellite-btn').classList.add('active');
                document.getElementById('map-btn').classList.remove('active');
            }
            currentLayer = type;
        }
        
        // Toggle property boundaries (using LINZ aerial as reference)
        function toggleBoundaries() {
            const checkbox = document.getElementById('boundaries-toggle');
            const label = document.getElementById('boundaries-label');
            
            if (checkbox.checked) {
                boundaryLayer.addTo(map);
                boundaryLayer.bringToBack();
                label.classList.add('active');
            } else {
                map.removeLayer(boundaryLayer);
                label.classList.remove('active');
            }
        }
        
        // Toggle contour lines
        function toggleContours() {
            const checkbox = document.getElementById('contours-toggle');
            const label = document.getElementById('contours-label');
            
            if (checkbox.checked) {
                contourLayer.addTo(map);
                // Keep contours behind drawn items but above base
                contourLayer.bringToBack();
                if (document.getElementById('boundaries-toggle').checked) {
                    boundaryLayer.bringToBack();
                }
                label.classList.add('active');
            } else {
                map.removeLayer(contourLayer);
                label.classList.remove('active');
            }
        }
        
        // ==========================================
        // WALL DRAWING FUNCTIONS
        // ==========================================
        
        function handleDrawCreated(e) {
            const layer = e.layer;
            wallCounter++;
            
            // Calculate length
            const latlngs = layer.getLatLngs();
            const distance = calculateTotalDistance(latlngs);
            
            // Store wall data
            layer.wallId = wallCounter;
            layer.wallDistance = distance;
            drawnWalls.push({
                id: wallCounter,
                layer: layer,
                distance: distance,
                latlngs: latlngs.map(ll => ({ lat: ll.lat, lng: ll.lng }))
            });
            
            // Add styled popup
            layer.bindPopup(`
                <div style="text-align: center;">
                    <strong style="color: #e74c3c;">Wall #${wallCounter}</strong><br>
                    <span style="font-size: 1.2em; font-weight: bold;">~${formatDistance(distance)}</span>
                    <span style="font-size: 0.75em; color: #666;">(est.)</span>
                </div>
            `);
            
            // Add to map
            drawnItems.addLayer(layer);
            
            // Update UI
            updateWallsList();
            updateQuoteSummary();
            
            // Show walls container
            document.getElementById('drawn-walls-container').style.display = 'block';
            
            // Auto-capture map snapshot
            setTimeout(() => captureMapSnapshot(), 500);
        }
        
        function handleDrawDeleted(e) {
            e.layers.eachLayer(function(layer) {
                drawnWalls = drawnWalls.filter(w => w.layer !== layer);
            });
            updateWallsList();
            updateQuoteSummary();
            
            if (drawnWalls.length === 0) {
                document.getElementById('drawn-walls-container').style.display = 'none';
                document.getElementById('snapshot-placeholder').style.display = 'block';
                document.getElementById('map-snapshot-img').style.display = 'none';
            } else {
                captureMapSnapshot();
            }
        }
        
        function handleDrawEdited(e) {
            e.layers.eachLayer(function(layer) {
                const latlngs = layer.getLatLngs();
                const distance = calculateTotalDistance(latlngs);
                layer.wallDistance = distance;
                layer.setPopupContent(`
                    <div style="text-align: center;">
                        <strong style="color: #e74c3c;">Wall #${layer.wallId}</strong><br>
                        <span style="font-size: 1.2em; font-weight: bold;">~${formatDistance(distance)}</span>
                        <span style="font-size: 0.75em; color: #666;">(est.)</span>
                    </div>
                `);
                
                const wall = drawnWalls.find(w => w.layer === layer);
                if (wall) {
                    wall.distance = distance;
                    wall.latlngs = latlngs.map(ll => ({ lat: ll.lat, lng: ll.lng }));
                }
            });
            updateWallsList();
            updateQuoteSummary();
            captureMapSnapshot();
        }
        
        function calculateTotalDistance(latlngs) {
            let total = 0;
            for (let i = 0; i < latlngs.length - 1; i++) {
                total += latlngs[i].distanceTo(latlngs[i + 1]);
            }
            return total;
        }
        
        function formatDistance(meters) {
            if (meters >= 1000) {
                return (meters / 1000).toFixed(2) + ' km';
            }
            return meters.toFixed(1) + ' m';
        }
        
        function updateWallsList() {
            const container = document.getElementById('walls-list');
            const totalDisplay = document.getElementById('total-length-display');
            
            if (drawnWalls.length === 0) {
                container.innerHTML = '<p style="color: var(--slate); font-style: italic;">No walls drawn yet</p>';
                totalDisplay.innerHTML = '';
                return;
            }
            
            let html = '';
            let totalLength = 0;
            
            drawnWalls.forEach((wall) => {
                totalLength += wall.distance;
                html += `
                    <div class="wall-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #e74c3c;">
                        <span><strong>Wall #${wall.id}</strong></span>
                        <span style="color: var(--teal-accent); font-weight: 600; font-size: 1.1rem;">~${formatDistance(wall.distance)} <span style="font-size: 0.75rem; color: var(--slate);">(est.)</span></span>
                        <button onclick="focusOnWall(${wall.id})" style="background: var(--teal-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üìç View</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            totalDisplay.innerHTML = `<strong>Est. Total Length:</strong> ~${formatDistance(totalLength)}<br><span style="font-size: 0.8rem; opacity: 0.9;">*Approximate only - actual measurements may vary</span>`;
        }
        
        function focusOnWall(wallId) {
            const wall = drawnWalls.find(w => w.id === wallId);
            if (wall) {
                map.fitBounds(wall.layer.getBounds(), { padding: [50, 50] });
                wall.layer.openPopup();
            }
        }
        
        // ==========================================
        // MAP SNAPSHOT
        // ==========================================
        
        async function captureMapSnapshot() {
            const mapElement = document.getElementById('site-map');
            const placeholder = document.getElementById('snapshot-placeholder');
            const snapshotImg = document.getElementById('map-snapshot-img');
            
            try {
                // Wait for tiles to load
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 1,
                    logging: false
                });
                
                mapSnapshot = canvas.toDataURL('image/png');
                
                // Update preview
                snapshotImg.src = mapSnapshot;
                snapshotImg.style.display = 'block';
                placeholder.style.display = 'none';
                
            } catch (error) {
                console.error('Map snapshot error:', error);
            }
        }
        
        // ==========================================
        // FILE UPLOAD
        // ==========================================
        
        function initializeFileUpload() {
            const uploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('file-input');
            
            // Click to upload
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--teal-accent)';
                uploadArea.style.background = 'var(--soft-blue)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--border-gray)';
                uploadArea.style.background = 'var(--light-gray)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border-gray)';
                uploadArea.style.background = 'var(--light-gray)';
                handleFiles(e.dataTransfer.files);
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }
        
        function handleFiles(files) {
            const maxFiles = 5;
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            Array.from(files).forEach(file => {
                if (uploadedFiles.length >= maxFiles) {
                    alert(`Maximum ${maxFiles} files allowed`);
                    return;
                }
                
                if (file.size > maxSize) {
                    alert(`${file.name} is too large. Maximum size is 10MB.`);
                    return;
                }
                
                // Read file as base64
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    updateFileList();
                    updateQuoteSummary();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function updateFileList() {
            const container = document.getElementById('file-list');
            
            if (uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = uploadedFiles.map((file, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--soft-blue); border-radius: 8px; margin-bottom: 8px;">
                    <span>
                        ${file.type.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ'} 
                        <strong>${file.name}</strong> 
                        <span style="color: var(--slate); font-size: 0.85rem;">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </span>
                    <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">‚úï</button>
                </div>
            `).join('');
        }
        
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            updateQuoteSummary();
        }
        
        // ==========================================
        // WALL TYPE SELECTION
        // ==========================================
        
        function toggleWallType(element, type) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
            
            if (type === 'other') {
                const otherInput = document.getElementById('other-wall-type');
                otherInput.style.display = checkbox.checked ? 'block' : 'none';
                if (checkbox.checked) {
                    otherInput.focus();
                }
            }
            
            updateQuoteSummary();
        }
        
        // ==========================================
        // QUOTE SUMMARY UPDATE
        // ==========================================
        
        function updateQuoteSummary() {
            // Services
            const servicesContainer = document.getElementById('summary-services');
            const selectedServicesSummary = document.getElementById('selected-services-summary');
            const stages = document.querySelectorAll('.stage-checkbox:checked');
            const stageNames = {
                '1': 'Site Planning',
                '2': 'Engineering Design',
                '3': 'Cost Estimate',
                '4': 'Council Consent',
                '5': 'Construction',
                '6': 'Final Sign-Off'
            };
            
            if (stages.length > 0) {
                let servicesHtml = '';
                let summaryHtml = '';
                stages.forEach(stage => {
                    const stageNum = stage.dataset.stage;
                    const name = stageNames[stageNum] || `Stage ${stageNum}`;
                    servicesHtml += `<li>‚úì ${name}</li>`;
                    summaryHtml += `<span class="service-tag">${name}</span>`;
                });
                servicesContainer.innerHTML = servicesHtml;
                if (selectedServicesSummary) {
                    selectedServicesSummary.innerHTML = summaryHtml;
                }
                
                const step1Number = document.getElementById('step1-number');
                if (step1Number) {
                    step1Number.innerHTML = '‚úì';
                    step1Number.style.background = '#28a745';
                }
            } else {
                servicesContainer.innerHTML = '<li style="color: rgba(255,255,255,0.6); font-style: italic;">None selected</li>';
                if (selectedServicesSummary) {
                    selectedServicesSummary.innerHTML = '<span style="color: var(--slate); font-style: italic;">No services selected yet. Please select from the circle above.</span>';
                }
            }
            
            // Location
            const locationDisplay = document.getElementById('summary-location');
            locationDisplay.textContent = selectedAddress || 'Not specified';
            
            // Walls
            const wallsDisplay = document.getElementById('summary-walls');
            if (drawnWalls.length > 0) {
                let totalLength = drawnWalls.reduce((sum, w) => sum + w.distance, 0);
                wallsDisplay.innerHTML = `${drawnWalls.length} wall(s) marked<br><strong>Est. Total: ~${formatDistance(totalLength)}</strong><br><span style="font-size: 0.8rem; opacity: 0.7;">*Approximate measurement</span>`;
            } else {
                wallsDisplay.textContent = 'No walls drawn';
            }
            
            // Wall types
            const wallTypesDisplay = document.getElementById('summary-wall-types');
            const selectedWallTypes = [];
            document.querySelectorAll('.wall-type-option input:checked').forEach(input => {
                if (input.id !== 'wall-other') {
                    selectedWallTypes.push(input.value);
                }
            });
            
            if (document.getElementById('wall-other')?.checked) {
                const otherValue = document.getElementById('other-wall-type').value;
                if (otherValue) {
                    selectedWallTypes.push(`Other: ${otherValue}`);
                } else {
                    selectedWallTypes.push('Other (not specified)');
                }
            }
            
            wallTypesDisplay.textContent = selectedWallTypes.length > 0 ? selectedWallTypes.join(', ') : 'None selected';
            
            // Contact details
            const contactDisplay = document.getElementById('summary-contact');
            const name = document.getElementById('client-name')?.value || '';
            const email = document.getElementById('client-email')?.value || '';
            const phone = document.getElementById('client-phone')?.value || '';
            
            if (name || email) {
                contactDisplay.innerHTML = `
                    ${name ? `<strong>${name}</strong><br>` : ''}
                    ${email ? `üìß ${email}<br>` : ''}
                    ${phone ? `üìû ${phone}` : ''}
                `;
            } else {
                contactDisplay.textContent = 'Not provided';
            }
            
            // Attachments
            const attachmentsDisplay = document.getElementById('summary-attachments');
            if (uploadedFiles.length > 0) {
                attachmentsDisplay.textContent = `${uploadedFiles.length} file(s) attached`;
            } else {
                attachmentsDisplay.textContent = 'No files attached';
            }
            
            // Notes
            const notesDisplay = document.getElementById('summary-notes');
            const notes = document.getElementById('client-notes')?.value || '';
            if (notes) {
                notesDisplay.textContent = notes.length > 200 ? notes.substring(0, 200) + '...' : notes;
                notesDisplay.style.fontStyle = 'normal';
            } else {
                notesDisplay.textContent = 'No notes added';
                notesDisplay.style.fontStyle = 'italic';
            }
        }
        
        // Listen for form field changes
        document.addEventListener('DOMContentLoaded', function() {
            // Service checkboxes
            document.querySelectorAll('.stage-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateQuoteSummary);
            });
            
            // Client detail inputs
            ['client-name', 'client-email', 'client-phone', 'client-company', 'client-notes', 'other-wall-type'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateQuoteSummary);
                }
            });
        });
        
        // ==========================================
        // SUBMIT QUOTE REQUEST
        // ==========================================
        
        function submitQuoteRequest() {
            // Validate required fields
            const name = document.getElementById('client-name')?.value?.trim() || '';
            const email = document.getElementById('client-email')?.value?.trim() || '';
            
            const validationMsg = document.getElementById('validation-message');
            
            if (!name || !email) {
                validationMsg.style.display = 'block';
                validationMsg.textContent = 'Please fill in your Name and Email address';
                document.getElementById('step-details').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            // Basic email validation
            if (!email.includes('@') || !email.includes('.')) {
                validationMsg.style.display = 'block';
                validationMsg.textContent = 'Please enter a valid email address';
                return;
            }
            
            validationMsg.style.display = 'none';
            
            // Gather all data
            const services = [];
            document.querySelectorAll('.stage-checkbox:checked').forEach(checkbox => {
                const stage = checkbox.closest('.journey-stage');
                services.push(stage.dataset.title);
            });
            
            const wallTypes = [];
            document.querySelectorAll('.wall-type-option input:checked').forEach(input => {
                wallTypes.push(input.value);
            });
            
            const quoteData = {
                timestamp: new Date().toISOString(),
                client: {
                    name: name,
                    email: email,
                    phone: document.getElementById('client-phone')?.value || '',
                    company: document.getElementById('client-company')?.value || ''
                },
                services: services,
                location: {
                    address: selectedAddress,
                    coordinates: selectedCoordinates
                },
                walls: drawnWalls.map(w => ({
                    id: w.id,
                    length: w.distance,
                    lengthFormatted: formatDistance(w.distance),
                    coordinates: w.latlngs
                })),
                totalWallLength: drawnWalls.reduce((sum, w) => sum + w.distance, 0),
                totalWallLengthFormatted: formatDistance(drawnWalls.reduce((sum, w) => sum + w.distance, 0)),
                wallTypes: wallTypes,
                otherWallType: document.getElementById('other-wall-type')?.value || '',
                notes: document.getElementById('client-notes')?.value || '',
                attachments: uploadedFiles.map(f => ({ name: f.name, type: f.type, size: f.size })),
                mapSnapshot: mapSnapshot
            };
            
            // Store in sessionStorage
            sessionStorage.setItem('quoteRequestData', JSON.stringify(quoteData));
            sessionStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
            
            // Create email content
            const emailBody = generateEmailBody(quoteData);
            
            // Show success modal and options
            showSubmissionModal(quoteData, emailBody);
        }
        
        function generateEmailBody(data) {
            let body = `NEW QUOTE REQUEST FROM REWALL WEBSITE\n`;
            body += `${'='.repeat(50)}\n\n`;
            
            body += `CLIENT DETAILS:\n`;
            body += `Name: ${data.client.name}\n`;
            body += `Email: ${data.client.email}\n`;
            body += `Phone: ${data.client.phone || 'Not provided'}\n`;
            body += `Company: ${data.client.company || 'Not provided'}\n\n`;
            
            body += `SERVICES REQUESTED:\n`;
            if (data.services.length > 0) {
                data.services.forEach(s => body += `‚Ä¢ ${s}\n`);
            } else {
                body += `No specific services selected\n`;
            }
            body += `\n`;
            
            body += `SITE LOCATION:\n`;
            body += `${data.location.address || 'Not specified'}\n`;
            if (data.location.coordinates) {
                body += `Coordinates: ${data.location.coordinates.lat.toFixed(6)}, ${data.location.coordinates.lon.toFixed(6)}\n`;
            }
            body += `\n`;
            
            body += `WALL MEASUREMENTS (ESTIMATED)*:\n`;
            if (data.walls.length > 0) {
                data.walls.forEach(w => body += `‚Ä¢ Wall #${w.id}: ~${w.lengthFormatted} (approx.)\n`);
                body += `EST. TOTAL LENGTH: ~${data.totalWallLengthFormatted}\n`;
                body += `*Note: These are approximate measurements based on map drawings and should not be relied upon for final calculations.\n`;
            } else {
                body += `No walls drawn on map\n`;
            }
            body += `\n`;
            
            body += `WALL TYPES:\n`;
            if (data.wallTypes.length > 0) {
                data.wallTypes.forEach(t => body += `‚Ä¢ ${t}\n`);
            } else {
                body += `Not specified\n`;
            }
            if (data.otherWallType) {
                body += `Other details: ${data.otherWallType}\n`;
            }
            body += `\n`;
            
            body += `PROJECT NOTES:\n`;
            body += `${data.notes || 'No notes provided'}\n\n`;
            
            body += `ATTACHMENTS:\n`;
            if (data.attachments.length > 0) {
                data.attachments.forEach(a => body += `‚Ä¢ ${a.name} (${(a.size/1024).toFixed(1)} KB)\n`);
            } else {
                body += `No files attached\n`;
            }
            body += `\n`;
            
            body += `${'='.repeat(50)}\n`;
            body += `Submitted: ${new Date().toLocaleString('en-NZ')}\n`;
            
            return body;
        }
        
        function showSubmissionModal(data, emailBody) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'submission-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, var(--teal-accent) 0%, #3a8a9a 100%); padding: 30px; border-radius: 16px 16px 0 0; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 10px;">üéâ</div>
                            <h2 style="color: white; margin: 0;">Quote Request Ready!</h2>
                            <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0;">Thank you, ${data.client.name}</p>
                        </div>
                        
                        <div style="padding: 30px;">
                            <p style="color: var(--slate); margin-bottom: 20px;">Your quote request has been prepared. Choose how you'd like to submit it:</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <button onclick="sendViaEmail('${data.client.email}')" style="padding: 16px 24px; background: var(--teal-accent); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    üìß Send via Email
                                    <span style="font-size: 0.85rem; opacity: 0.8;">(Opens your email client)</span>
                                </button>
                                
                                <button onclick="copyToClipboard()" style="padding: 16px 24px; background: var(--primary-black); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    üìã Copy Summary
                                    <span style="font-size: 0.85rem; opacity: 0.8;">(Paste anywhere)</span>
                                </button>
                                
                                <button onclick="downloadSummary()" style="padding: 16px 24px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    üíæ Download Summary
                                    <span style="font-size: 0.85rem; opacity: 0.8;">(Save as text file)</span>
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: var(--soft-blue); border-radius: 8px;">
                                <p style="margin: 0; font-size: 0.9rem; color: var(--slate);">
                                    <strong>üìû Prefer to call?</strong><br>
                                    Ring us at <a href="tel:+64273941127" style="color: var(--teal-accent); font-weight: 600;">027 394 1127</a> and mention your quote reference.
                                </p>
                            </div>
                            
                            <button onclick="closeSubmissionModal()" style="margin-top: 20px; padding: 12px 24px; background: var(--light-gray); color: var(--primary-black); border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; width: 100%;">
                                ‚Üê Back to Quote Builder
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store email body for later use
            window.currentEmailBody = emailBody;
        }
        
        function closeSubmissionModal() {
            const modal = document.getElementById('submission-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function sendViaEmail(clientEmail) {
            const subject = encodeURIComponent('ReWall Quote Request - ' + new Date().toLocaleDateString('en-NZ'));
            const body = encodeURIComponent(window.currentEmailBody);
            
            // Open email client
            window.location.href = `mailto:info@databloc.nz?cc=${clientEmail}&subject=${subject}&body=${body}`;
        }
        
        function copyToClipboard() {
            navigator.clipboard.writeText(window.currentEmailBody).then(() => {
                alert('‚úì Summary copied to clipboard!\n\nYou can now paste it into an email or document.');
            }).catch(err => {
                console.error('Copy failed:', err);
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = window.currentEmailBody;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úì Summary copied to clipboard!');
            });
        }
        
        function downloadSummary() {
            const data = JSON.parse(sessionStorage.getItem('quoteRequestData'));
            const filename = `ReWall_Quote_${data.client.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            
            const blob = new Blob([window.currentEmailBody], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
